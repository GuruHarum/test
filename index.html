<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daftar Hadir Gemar Mengaji - SDIT Harapan Umat Karawang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8f9fa;
        }
        
        .header-gradient {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .fade-out {
            animation: fadeOut 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        .page-transition {
            transition: all 0.5s ease-in-out;
        }
        
        .modal {
            backdrop-filter: blur(8px);
            background-color: rgba(0, 0, 0, 0.4);
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
        }
        
        .modal-content {
            transform: scale(0.7);
            opacity: 0;
            transition: all 0.3s ease-in-out;
        }
        
        .modal.show .modal-content {
            transform: scale(1);
            opacity: 1;
        }
        
        .teacher-card {
            transition: all 0.3s ease;
        }
        
        .teacher-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .attendance-option {
            transition: all 0.2s ease;
        }
        
        .attendance-option:hover {
            transform: scale(1.05);
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            transform: translateX(150%);
            transition: transform 0.5s ease-in-out;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .student-row {
            transition: all 0.3s ease;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 12px;
        }
        
        .student-row:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .attendance-badge {
            transition: all 0.3s ease;
        }
        
        .attendance-badge:hover {
            transform: scale(1.05);
        }
        
        .thank-you-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s ease;
        }
        
        .thank-you-modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .thank-you-content {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            transform: translateY(20px);
            transition: all 0.5s ease;
            max-width: 90%;
            width: 400px;
        }
        
        .thank-you-modal.show .thank-you-content {
            transform: translateY(0);
        }
        
        .logo-circle {
            border-radius: 50%;
            overflow: hidden;
            width: 64px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo-circle img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .admin-panel {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .status-badge.hadir {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .status-badge.sakit {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .status-badge.izin {
            background-color: #dbeafe;
            color: #1e40af;
        }
        
        .status-badge.alpha {
            background-color: #fee2e2;
            color: #b91c1c;
        }
        
        .shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        .student-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            overflow: hidden;
            margin-bottom: 16px;
        }
        
        .student-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }
        
        .student-header {
            padding: 16px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .student-content {
            padding: 16px;
        }
        
        .note-container {
            background-color: #f9fafb;
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
        }
        
        .attendance-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .attendance-table {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        .attendance-table th {
            background-color: #f8fafc;
            font-weight: 600;
            text-align: left;
            padding: 12px 16px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .attendance-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .attendance-table tr:last-child td {
            border-bottom: none;
        }
        
        .attendance-table tr:hover td {
            background-color: #f8fafc;
        }
        
        .filter-container {
            background-color: #f8fafc;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
        }
        
        .filter-group {
            margin-bottom: 16px;
        }
        
        .filter-label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: #334155;
        }
        
        .filter-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            background-color: white;
            font-size: 0.875rem;
            color: #334155;
            transition: all 0.2s ease;
        }
        
        .filter-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .filter-button {
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .filter-button:hover {
            background-color: #2563eb;
        }
        
        .filter-button:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        
        .monthly-report-table {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 24px;
        }
        
        .monthly-report-table th {
            background-color: #f1f5f9;
            font-weight: 600;
            text-align: center;
            padding: 10px;
            border: 1px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .monthly-report-table td {
            padding: 8px;
            border: 1px solid #e2e8f0;
            text-align: center;
            font-size: 0.875rem;
        }
        
        .monthly-report-table .student-name {
            text-align: left;
            font-weight: 500;
            background-color: #f8fafc;
            position: sticky;
            left: 0;
            z-index: 5;
        }
        
        .monthly-report-table .date-header {
            min-width: 40px;
            font-size: 0.875rem;
        }
        
        .monthly-report-table .summary-header {
            background-color: #e0f2fe;
        }
        
        .monthly-report-table .summary-cell {
            background-color: #f0f9ff;
            font-weight: 500;
        }
        
        .monthly-report-table .percentage-cell {
            background-color: #dbeafe;
            font-weight: 600;
            color: #1e40af;
        }
        
        .monthly-report-table .status-H {
            background-color: #d1fae5;
            color: #065f46;
            font-weight: 600;
        }
        
        .monthly-report-table .status-S {
            background-color: #fef3c7;
            color: #92400e;
            font-weight: 600;
        }
        
        .monthly-report-table .status-I {
            background-color: #dbeafe;
            color: #1e40af;
            font-weight: 600;
        }
        
        .monthly-report-table .status-- {
            background-color: #fee2e2;
            color: #b91c1c;
            font-weight: 600;
        }
        
        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .report-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e40af;
        }
        
        .report-info {
            margin-bottom: 16px;
        }
        
        .report-info-item {
            margin-bottom: 4px;
        }
        
        .report-info-label {
            font-weight: 500;
            color: #475569;
        }
        
        .print-button {
            background-color: #4ade80;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
        }
        
        .print-button:hover {
            background-color: #22c55e;
        }
        
        .print-button svg {
            margin-right: 8px;
        }
        
@media print {
  body * {
    visibility: hidden !important;
  }
  #reportContainer, #reportContainer * {
    visibility: visible !important;
  }
  #reportContainer {
    position: absolute !important;
    left: 0 !important;
    top: 0 !important;
    width: 297mm !important; /* A4 landscape width */
    min-height: 210mm !important; /* A4 landscape height */
    background: white !important;
    margin: 0 !important;
    padding: 0 !important;
    box-sizing: border-box !important;
    font-size: 11pt !important;
    page-break-before: auto !important;
    page-break-after: auto !important;
    page-break-inside: avoid !important;
  }
            
            .no-print {
                display: none !important;
            }
            
            .monthly-report-table {
    width: 100% !important;
    font-size: 10pt !important;
    border: 1px solid #000 !important;
    page-break-inside: avoid !important;
  }
  .header-gradient, .footer, .no-print {
    display: none !important;
  }
  .admin-panel {
    box-shadow: none !important;
    margin: 0 !important;
    padding: 0 !important;
  }
}
        
        .selected-option {
            position: relative;
        }
        
        .selected-option::after {
            content: '✓';
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #3b82f6;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .inline-loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s linear infinite;
            margin-left: 8px;
            vertical-align: middle;
        }
        
        .content-placeholder {
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .refresh-button {
            background-color: #e0f2fe;
            color: #1e40af;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            font-size: 0.875rem;
        }
        
        .refresh-button:hover {
            background-color: #bae6fd;
        }
        
        .refresh-button svg {
            margin-right: 6px;
        }
        
        .refresh-icon {
            display: inline-block;
            animation: none;
            transition: all 0.3s ease;
        }
        
        .refresh-icon.spinning {
            animation: spin 1s linear infinite;
        }
        
        .loading-indicator {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .loading-indicator.show {
            visibility: visible;
            opacity: 1;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 6px solid #f3f3f3;
            border-top: 6px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .pdf-button {
            background-color: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
        }
        
        .pdf-button:hover {
            background-color: #dc2626;
        }
        
        .pdf-button svg {
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="loading-indicator">
        <div class="loading-spinner"></div>
    </div>

    <!-- Header -->
    <header class="header-gradient shadow-md">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center">
                <div class="logo-circle mr-4">
                    <img src="https://iili.io/FjF61ou.png" alt="Logo SDIT Harapan Umat" class="h-full w-full object-cover">
                </div>
                <div>
                    <h1 class="text-xl font-bold text-white">SDIT Harapan Umat Karawang</h1>
                    <p class="text-sm text-blue-100">Jl. Pakuncen No. 01, Desa Sukaharja, Kec. Teluk Jambe Timur</p>
                </div>
            </div>
            <div>
                <button id="loginBtn" class="bg-white hover:bg-blue-50 text-blue-800 font-medium py-2 px-4 rounded-lg transition duration-300 shadow-md">
                    Login Admin
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Page 1: Teacher Selection -->
        <div id="page1" class="page-transition">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-blue-800 mb-2">Daftar Hadir Kegiatan Gemar Mengaji</h2>
                <p class="text-gray-600">Silakan pilih guru untuk melanjutkan</p>
            </div>
            
            <div id="teacherGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <!-- Teachers will be loaded here -->
                <div class="col-span-full flex justify-center">
                    <div class="w-full h-32 max-w-sm rounded-lg shimmer"></div>
                </div>
            </div>
        </div>
        
        <!-- Page 2: Student Attendance -->
        <div id="page2" class="page-transition hidden">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-blue-800" id="classTitle"></h2>
                    <div class="flex items-center text-gray-600 mt-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <span id="currentDate"></span>
                    </div>
                </div>
                <div class="flex items-center">
                    <a href="https://desty.page/sditharapanummahkrw/materitahsintahfidz" target="_blank" id= "materiLinkBtn" class="refresh-button mr-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 refresh-icon" fill= "none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 3v4a1 1 0 001 1h4m-5 10l6-6m0 01-6-6m6 6H3" />
                        </svg>
                        Link Materi
                    </a>
                    <button id="backToHome" class="bg-blue-100 hover:bg-blue-200 text-blue-800 font-medium py-2 px-4 rounded-lg transition duration-300 flex items-center shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9.707 14.707a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 1.414L7.414 9H15a1 1 0 110 2H7.414l2.293 2.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                        </svg>
                        Kembali
                    </button>
                </div>
            </div>
            
            <div id="studentList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Students will be loaded here -->
                <div class="col-span-full">
                    <div class="w-full h-32 rounded shimmer mb-2"></div>
                    <div class="w-full h-32 rounded shimmer mb-2"></div>
                    <div class="w-full h-32 rounded shimmer"></div>
                </div>
            </div>
        </div>
        
        <!-- Page 3: Admin Panel -->
        <div id="page3" class="page-transition hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-blue-800">Panel Admin</h2>
                <div class="flex items-center">
                    <button id="refreshAdminDataBtn" class="refresh-button mr-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 refresh-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        Refresh Data
                    </button>
                    <button id="logoutBtn" class="bg-red-100 hover:bg-red-200 text-red-800 font-medium py-2 px-4 rounded-lg transition duration-300 flex items-center shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 001 1h12a1 1 0 001-1V4a1 1 0 00-1-1H3zm11 4a1 1 0 10-2 0v4a1 1 0 102 0V7z" clip-rule="evenodd" />
                            <path d="M4 7a1 1 0 011-1h4a1 1 0 110 2H5a1 1 0 01-1-1z" />
                        </svg>
                        Logout
                    </button>
                </div>
            </div>
            
            <div class="admin-panel mb-8">
                <h3 class="text-xl font-semibold text-blue-800 mb-4">Filter Data Absensi</h3>
                
                <div class="filter-container">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="filter-group">
                            <label for="filterMonth" class="filter-label">Bulan</label>
                            <select id="filterMonth" class="filter-select">
                                <option value="">Pilih Bulan</option>
                                <option value="01">Januari</option>
                                <option value="02">Februari</option>
                                <option value="03">Maret</option>
                                <option value="04">April</option>
                                <option value="05">Mei</option>
                                <option value="06">Juni</option>
                                <option value="07">Juli</option>
                                <option value="08">Agustus</option>
                                <option value="09">September</option>
                                <option value="10">Oktober</option>
                                <option value="11">November</option>
                                <option value="12">Desember</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filterTeacher" class="filter-label">Guru</label>
                            <select id="filterTeacher" class="filter-select">
                                <option value="">Semua Guru</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filterClassNumber" class="filter-label">Tingkat Kelas</label>
                            <select id="filterClassNumber" class="filter-select">
                                <option value="">Semua Tingkat</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="filter-group" id="filterClassNameContainer">
                        <label for="filterClassName" class="filter-label">Nama Kelas</label>
                        <select id="filterClassName" class="filter-select">
                            <option value="">Semua Nama Kelas</option>
                        </select>
                    </div>
                    
                    <div class="flex flex-col md:flex-row gap-4 mt-4">
                        <button id="filterBtn" class="filter-button bg-blue-600 hover:bg-blue-700 flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd" />
                            </svg>
                            Terapkan Filter
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Monthly Attendance Report -->
            <div id="reportContainer" class="admin-panel mb-8" style="display: none;">
                <div class="report-header">
                    <div>
                        <h3 class="text-xl font-semibold text-blue-800 mb-2">Rekap Absensi Bulanan</h3>
                        <div class="report-info">
                            <div class="report-info-item">
                                <span class="report-info-label">Guru:</span>
                                <span id="reportTeacher">-</span>
                            </div>
                            <div class="report-info-item">
                                <span class="report-info-label">Kelas:</span>
                                <span id="reportClass">-</span>
                            </div>
                            <div class="report-info-item">
                                <span class="report-info-label">Bulan:</span>
                                <span id="reportMonth">-</span>
                            </div>
                            <div class="report-info-item">
                                <span class="report-info-label">Rata-rata Kehadiran:</span>
                                <span id="reportAverage">--%</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button id="printReportBtn" class="print-button no-print">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v2a2 2 0 002 2h6a2 2 0 002-2v-2h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd" />
                            </svg>
                            Cetak Laporan
                        </button>
                        <button id="exportPdfBtn" class="pdf-button no-print">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V8z" clip-rule="evenodd" />
                            </svg>
                            Download PDF
                        </button>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table id="monthlyReportTable" class="monthly-report-table">
                        <!-- Monthly report will be generated here -->
                        <tr>
                            <td colspan="32" class="py-8 text-center">
                                <div class="w-full h-12 rounded shimmer mb-2"></div>
                                <div class="w-full h-12 rounded shimmer mb-2"></div>
                                <div class="w-full h-12 rounded shimmer"></div>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            
            <div class="admin-panel mb-8">
                <h3 class="text-xl font-semibold text-blue-800 mb-4">Data Absensi</h3>
                <div class="overflow-x-auto">
                    <table class="attendance-table">
                        <thead>
                            <tr>
                                <th class="rounded-tl-lg">Tanggal</th>
                                <th>Guru</th>
                                <th>Kelas</th>
                                <th>Nama Siswa</th>
                                <th>Status</th>
                                <th class="rounded-tr-lg">Catatan</th>
                            </tr>
                        </thead>
                        <tbody id="adminDataList">
                            <!-- Admin data will be loaded here -->
                            <tr>
                                <td colspan="6" class="py-8 text-center">
                                    <div class="w-full h-12 rounded shimmer mb-2"></div>
                                    <div class="w-full h-12 rounded shimmer mb-2"></div>
                                    <div class="w-full h-12 rounded shimmer"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 flex justify-between items-center">
                    <div class="text-sm text-gray-600">
                        Menampilkan <span id="recordCount">0</span> data
                    </div>
                    <div class="flex space-x-2">
                        <button id="prevPage" class="px-3 py-1 bg-gray-100 text-gray-700 rounded-md disabled:opacity-50 disabled:cursor-not-allowed">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <span id="pageIndicator" class="px-3 py-1 bg-blue-100 text-blue-800 rounded-md">1</span>
                        <button id="nextPage" class="px-3 py-1 bg-gray-100 text-gray-700 rounded-md disabled:opacity-50 disabled:cursor-not-allowed">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-blue-800 text-white py-4 footer">
        <div class="container mx-auto px-4 text-center">
            <p>Hak Cipta SDIT Harapan Umat Karawang</p>
        </div>
    </footer>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content bg-white w-full max-w-md mx-auto mt-20 rounded-lg shadow-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-blue-800">Login Admin</h3>
                <button id="closeLoginModal" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                    <input type="text" id="username" name="username" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="password" name="password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-300">Masuk</button>
            </form>
        </div>
    </div>

    <!-- Class Selection Modal -->
    <div id="classModal" class="modal">
        <div class="modal-content bg-white w-full max-w-md mx-auto mt-20 rounded-lg shadow-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-blue-800">Pilih Kelas</h3>
                <button id="closeClassModal" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div id="classOptions" class="grid grid-cols-2 gap-4">
                <!-- Class options will be dynamically generated -->
                <div class="col-span-2 flex justify-center">
                    <div class="w-full h-32 rounded shimmer"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification bg-white rounded-lg shadow-lg p-4 max-w-md">
        <div id="notificationContent" class="flex items-center">
            <!-- Notification content will be inserted here -->
        </div>
    </div>

    <!-- Thank You Modal -->
    <div id="thankYouModal" class="thank-you-modal">
        <div class="thank-you-content">
            <div class="mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
            <h3 class="text-2xl font-bold text-white mb-2">Terimakasih Ayah/Bunda</h3>
            <p class="text-white text-opacity-90 mb-4">Absensi berhasil disimpan!</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Google Apps Script Web App URL - Replace with your actual deployed script URL
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw2itMBTKF49ugT-xbEUY1PI_Tpgg89W3Wmy8gB4bCv0XWNms0mXo-zHQYmoqZx6IeuHA/exec';
        // Google Sheets CSV URLs
        const TEACHERS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTgKecXy9cdc6rsoGURVhUJDJB6hloM7RC4P2cvC3bFw7ezL73KJFSgNURKL33YBndg5pBm9fZST7Hb/pub?output=csv';
        const STUDENTS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRo9cNtTtxitP8XPlHXbnT-458XW2xzsCUNAkFY-M9FmxzRJrSXKHeJfFYoTfLXfpSS0ICcKQYUkIEm/pub?output=csv';
        const ATTENDANCE_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSss3RvFno19G-Vrf7yfmtE39NOHX-UON6FlrbdYi_MbJLkXkNyuQe7n2tAbsbgVlsbGp2dvZnUyYpw/pub?output=csv';
        
        // Global variables
        let teachersData = [];
        let studentsData = [];
        let attendanceData = [];
        let selectedTeacher = null;
        let selectedClass = null;
        let isAdmin = false;
        let currentPage = 1;
        let recordsPerPage = 10;
        let filteredAttendanceData = [];
        let classesData = new Map(); // Map to store class data (number -> array of full class names)
        let classNamesByNumber = new Map(); // Map to store class names by class number
        let attendanceChartInstance = null;
        let statusChartInstance = null;
        let selectedStudentStatus = {}; // To track selected status for each student
        let autoSubmitTimer = null; // Timer for auto-submitting alpha attendance
        let adminDataFetched = false; // Flag to track if admin data has been fetched
        
        // DOM Elements
        const page1 = document.getElementById('page1');
        const page2 = document.getElementById('page2');
        const page3 = document.getElementById('page3');
        const teacherGrid = document.getElementById('teacherGrid');
        const studentList = document.getElementById('studentList');
        const adminDataList = document.getElementById('adminDataList');
        const classTitle = document.getElementById('classTitle');
        const currentDate = document.getElementById('currentDate');
        const loginModal = document.getElementById('loginModal');
        const classModal = document.getElementById('classModal');
        const notification = document.getElementById('notification');
        const thankYouModal = document.getElementById('thankYouModal');
        const classOptions = document.getElementById('classOptions');
        const filterMonth = document.getElementById('filterMonth');
        const filterTeacher = document.getElementById('filterTeacher');
        const filterClassNumber = document.getElementById('filterClassNumber');
        const filterClassName = document.getElementById('filterClassName');
        const filterClassNameContainer = document.getElementById('filterClassNameContainer');
        const recordCount = document.getElementById('recordCount');
        const pageIndicator = document.getElementById('pageIndicator');
        const prevPageBtn = document.getElementById('prevPage');
        const nextPageBtn = document.getElementById('nextPage');
        const reportContainer = document.getElementById('reportContainer');
        const monthlyReportTable = document.getElementById('monthlyReportTable');
        const reportTeacher = document.getElementById('reportTeacher');
        const reportClass = document.getElementById('reportClass');
        const reportMonth = document.getElementById('reportMonth');
        const printReportBtn = document.getElementById('printReportBtn');
        const exportPdfBtn = document.getElementById('exportPdfBtn');
        const refreshStudentsBtn = document.getElementById('refreshStudentsBtn');
        const refreshAdminDataBtn = document.getElementById('refreshAdminDataBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        
        function addDebugLog(message, data) {
    if (console && console.log) {
        console.log('[DEBUG]', message, data || '');
    }
}

        
        // Show/hide loading indicator
        function showLoading() {
            loadingIndicator.classList.add('show');
        }
        
        function hideLoading() {
            loadingIndicator.classList.remove('show');
        }
        
        // Format current date for display
        function formatCurrentDate() {
            const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            
            const now = new Date();
            const day = days[now.getDay()];
            const date = now.getDate();
            const month = months[now.getMonth()];
            const year = now.getFullYear();
            
            return `${day}, ${date} ${month} ${year}`;
        }
        
        // Format date for storage and API (YYYY-MM-DD)
        function formatDateForStorage() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Format date for display (DD/MM/YYYY)
        function formatDateForDisplay(dateString) {
            if (!dateString) return '';
            
            const parts = dateString.split('-');
            if (parts.length !== 3) return dateString;
            
            return `${parts[2]}/${parts[1]}/${parts[0]}`;
        }
        
        // Get month name from month number
        function getMonthName(monthNumber) {
            const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            return months[parseInt(monthNumber) - 1];
        }
        
        // Get days in month
        function getDaysInMonth(year, month) {
            return new Date(year, month, 0).getDate();
        }
        
        // Parse CSV data
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            if (lines.length === 0) return [];
            
            const headers = lines[0].split(',').map(header => header.trim());
            
            const result = [];
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                // Handle commas within quoted fields
                let values = [];
                let inQuotes = false;
                let currentValue = '';
                
                for (let j = 0; j < lines[i].length; j++) {
                    const char = lines[i][j];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(currentValue);
                        currentValue = '';
                    } else {
                        currentValue += char;
                    }
                }
                
                // Add the last value
                values.push(currentValue);
                
                // If simple split would work (no quoted fields with commas)
                if (values.length !== headers.length) {
                    values = lines[i].split(',');
                }
                
                const entry = {};
                for (let j = 0; j < headers.length; j++) {
                    // Remove quotes if present
                    let value = j < values.length ? values[j] : '';
                    if (value.startsWith('"') && value.endsWith('"')) {
                        value = value.substring(1, value.length - 1);
                    }
                    entry[headers[j]] = value.trim();
                }
                
                result.push(entry);
            }
            
            return result;
        }
        
        // Check if attendance was already recorded today
        function isAttendanceRecorded(studentName, date = null) {
            const checkDate = date || formatDateForStorage();
            
            // Filter attendance data for this student, teacher, class, and date
            const record = attendanceData.find(record => 
                record.date === checkDate && 
                record.teacher === selectedTeacher && 
                record.student === studentName
            );
            
            return record !== undefined;
        }
        
        // Get attendance record for a student on a specific date
        function getAttendanceRecord(studentName, date = null) {
            const checkDate = date || formatDateForStorage();
            
            // Find attendance record for this student, teacher, and date
            return attendanceData.find(record => 
                record.date === checkDate && 
                record.teacher === selectedTeacher && 
                record.student === studentName
            );
        }
        
        // Extract class number from class name
        function extractClassNumber(className) {
            if (!className) return null;
            
            // Extract the first number from the class string
            const match = className.match(/\d+/);
            return match ? match[0] : null;
        }
        
        // Check if class name is a simple number or contains additional text
        function isSimpleClassNumber(className) {
            if (!className) return false;
            return /^\d+$/.test(className);
        }
        
        // Check if class name contains both numbers and text
        function isComplexClassName(className) {
            if (!className) return false;
            
            // Check if it contains at least one digit and one letter
            return /\d/.test(className) && /[a-zA-Z]/.test(className);
        }
        
        // Save attendance record to Google Sheets using iframe method
        async function saveAttendance(studentName, status, note, studentClass) {
            showLoading('Menyimpan data absensi...');
            addDebugLog('Saving attendance', { studentName, status, note });
            
            const today = formatDateForStorage();
            
            // Create attendance record
            const record = {
                date: today,
                teacher: selectedTeacher,
                class: studentClass, // Send the full class name
                student: studentName,
                status: status,
                note: note || ''
            };
            
            try {
                // Create a form element to submit data
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = SCRIPT_URL;
                form.target = 'hidden-iframe';
                form.style.display = 'none';
                
                // Add action parameter
                const actionInput = document.createElement('input');
                actionInput.type = 'hidden';
                actionInput.name = 'action';
                actionInput.value = 'saveAttendance';
                form.appendChild(actionInput);
                
                // Add data parameters
                for (const [key, value] of Object.entries(record)) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = value;
                    form.appendChild(input);
                }
                
                // Create hidden iframe for form submission
                let iframe = document.getElementById('hidden-iframe');
                if (!iframe) {
                    iframe = document.createElement('iframe');
                    iframe.name = 'hidden-iframe';
                    iframe.id = 'hidden-iframe';
                    iframe.style.display = 'none';
                    document.body.appendChild(iframe);
                }
                
                // Add form to document and submit
                document.body.appendChild(form);
                
                // Create a promise that resolves when the iframe loads
                const submissionPromise = new Promise((resolve) => {
                    iframe.onload = () => {
                        resolve(true);
                    };
                    
                    // Set a timeout in case the iframe doesn't load
                    setTimeout(() => {
                        resolve(true); // Assume success after timeout
                    }, 3000);
                });
                
                form.submit();
                
                // Wait for iframe to load or timeout
                await submissionPromise;
                
                // Remove form from document
                document.body.removeChild(form);
                
                // Add the record to our local array
                attendanceData.push(record);
                
                addDebugLog('Attendance saved successfully', record);
                hideLoading();
                return true;
            } catch (error) {
                console.error('Error saving attendance:', error);
                addDebugLog('Error saving attendance', error.toString());
                hideLoading();
                return false;
            }
        }
        
        // Alternative method using XMLHttpRequest
        async function saveAttendanceXHR(studentName, status, note, studentClass) {
            showLoading('Menyimpan data absensi...');
            addDebugLog('Saving attendance with XHR', { studentName, status, note });
            
            const today = formatDateForStorage();
            
            // Create attendance record
            const record = {
                date: today,
                teacher: selectedTeacher,
                class: studentClass, // Send the full class name
                student: studentName,
                status: status,
                note: note || ''
            };
            
            return new Promise((resolve) => {
                const xhr = new XMLHttpRequest();
                
                // Create form data
                const formData = new FormData();
                formData.append('action', 'saveAttendance');
                
                // Add all record fields
                for (const [key, value] of Object.entries(record)) {
                    formData.append(key, value);
                }
                
                xhr.open('POST', SCRIPT_URL, true);
                
                xhr.onload = function() {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        // Add the record to our local array
                        attendanceData.push(record);
                        addDebugLog('XHR Attendance saved successfully', record);
                        hideLoading();
                        resolve(true);
                    } else {
                        addDebugLog('XHR Error saving attendance', xhr.responseText);
                        hideLoading();
                        resolve(false);
                    }
                };
                
                xhr.onerror = function() {
                    addDebugLog('XHR Network error saving attendance');
                    hideLoading();
                    resolve(false);
                };
                
                xhr.send(formData);
            });
        }
        
        // Add cache busting parameter to URL to prevent caching
        function addCacheBuster(url) {
            const cacheBuster = `cache=${Date.now()}`;
            return url.includes('?') ? `${url}&${cacheBuster}` : `${url}?${cacheBuster}`;
        }
        
        // Fetch Teachers Data from Google Sheets CSV
        async function fetchTeachers() {
            try {
                showLoading();
                
                const response = await fetch(addCacheBuster(TEACHERS_CSV_URL));
                if (!response.ok) {
                    throw new Error('Failed to fetch teachers data');
                }
                
                const csvText = await response.text();
                teachersData = parseCSV(csvText);
                
                renderTeachers();
                populateTeacherDropdown();
                hideLoading();
            } catch (error) {
                console.error('Error fetching teachers:', error);
                showNotification('error', 'Gagal memuat data guru. Silakan coba lagi.');
                teacherGrid.innerHTML = `
                    <div class="col-span-full text-center p-8">
                        <p class="text-red-500">Gagal memuat data guru. Silakan refresh halaman.</p>
                    </div>
                `;
                hideLoading();
            }
        }
        
        // Fetch Students Data from Google Sheets CSV
        async function fetchStudents() {
            try {
                showLoading();
                
                const response = await fetch(addCacheBuster(STUDENTS_CSV_URL));
                if (!response.ok) {
                    throw new Error('Failed to fetch students data');
                }
                
                const csvText = await response.text();
                studentsData = parseCSV(csvText);
                
                classesData.clear();
                classNamesByNumber.clear();
                
                // Process class data for filtering
                studentsData.forEach(student => {
                    const className = student.kelas;
                    const classNumber = extractClassNumber(className);
                    
                    if (classNumber) {
                        if (!classesData.has(classNumber)) {
                            classesData.set(classNumber, new Set());
                        }
                        
                        // Add all class names to the set
                        classesData.get(classNumber).add(className);
                        
                        // Store complex class names (with both numbers and text) separately
                        if (isComplexClassName(className)) {
                            if (!classNamesByNumber.has(classNumber)) {
                                classNamesByNumber.set(classNumber, new Set());
                            }
                            classNamesByNumber.get(classNumber).add(className);
                        }
                    }
                });
                
                populateClassFilters();
                hideLoading();
                
                // If we're on page 2, refresh the student list
                if (!page2.classList.contains('hidden')) {
                    renderStudents();
                }
            } catch (error) {
                console.error('Error fetching students:', error);
                showNotification('error', 'Gagal memuat data siswa. Silakan coba lagi.');
                hideLoading();
            }
        }
        
        // Fetch Attendance Data from Google Sheets CSV
        async function fetchAttendanceData() {
            showLoading();
            
            try {
                const response = await fetch(addCacheBuster(ATTENDANCE_CSV_URL));
                if (!response.ok) {
                    throw new Error('Failed to fetch attendance data');
                }
                
                const csvText = await response.text();
                attendanceData = parseCSV(csvText);

                console.log('attendanceData:', attendanceData);
                
                // Map CSV column names to our expected property names
                attendanceData = attendanceData.map(record => ({
                    date: record.date || record.tanggal || record.Tanggal || '',
                    teacher: record.teacher || record.guru || record.Guru || '',
                    class: record.class || record.kelas || record.Kelas || '',
                    student: record.student || record.siswa || record['nama siswa'] || record['Nama Siswa'] || '',
                    status: record.status || record.Status || '',
                    note: record.note || record.catatan || record.Catatan || ''
                }));
                
                if (isAdmin) {
                    renderAdminData();
                    checkAndUpdateMonthlyReport();
                }
                
                // If we're on page 2, refresh the student list
                if (!page2.classList.contains('hidden')) {
                    renderStudents();
                }
                
                hideLoading();
            } catch (error) {
                console.error('Error fetching attendance data:', error);
                showNotification('error', 'Gagal memuat data absensi. Silakan coba lagi.');
                hideLoading();
            }
        }
        
        // Check if we need to update the monthly report
        function checkAndUpdateMonthlyReport() {
            const month = filterMonth.value;
            const teacher = filterTeacher.value;
            const classNumber = filterClassNumber.value;
            const className = filterClassName.value;
            
            // Check if we have enough filters to show the monthly report
            const showMonthlyReport = month && (classNumber || className);
            
            if (showMonthlyReport && reportContainer.style.display !== 'none') {
                generateMonthlyReport(month, teacher, classNumber, className);
            }
        }
        
        // Populate Teacher Dropdown for Admin Panel
        function populateTeacherDropdown() {
            const dropdown = document.getElementById('filterTeacher');
            
            // Clear existing options except the first one
            while (dropdown.options.length > 1) {
                dropdown.remove(1);
            }
            
            // Add teacher options
            teachersData.forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher.nama;
                option.textContent = teacher.nama;
                dropdown.appendChild(option);
            });
        }
        
        // Populate Class Filters for Admin Panel
        function populateClassFilters() {
            const classNumberDropdown = document.getElementById('filterClassNumber');
            
            // Clear existing options except the first one
            while (classNumberDropdown.options.length > 1) {
                classNumberDropdown.remove(1);
            }
            
            // Add class number options (sorted numerically)
            Array.from(classesData.keys())
                .sort((a, b) => parseInt(a) - parseInt(b))
                .forEach(classNumber => {
                    const option = document.createElement('option');
                    option.value = classNumber;
                    option.textContent = `Kelas ${classNumber}`;
                    classNumberDropdown.appendChild(option);
                });
            
            // Add event listener to class number dropdown
            classNumberDropdown.addEventListener('change', function() {
                const selectedClassNumber = this.value;
                updateClassNameDropdown(selectedClassNumber);
            });
            
            // Initially hide class name container
            filterClassNameContainer.style.display = 'none';
        }
        
        // Update Class Name Dropdown based on selected Class Number
        function updateClassNameDropdown(classNumber) {
            const classNameDropdown = document.getElementById('filterClassName');
            
            // Clear existing options
            while (classNameDropdown.options.length > 1) {
                classNameDropdown.remove(1);
            }
            
            if (!classNumber) {
                // Hide class name container if no class number selected
                filterClassNameContainer.style.display = 'none';
                return;
            }
            
            // Get complex class names for the selected class number
            const classNames = classNamesByNumber.get(classNumber);
            
            if (!classNames || classNames.size === 0) {
                filterClassNameContainer.style.display = 'none';
                return;
            }
            
            // Show class name container
            filterClassNameContainer.style.display = 'block';
            
            // Add class name options (sorted alphabetically)
            Array.from(classNames)
                .sort()
                .forEach(className => {
                    const option = document.createElement('option');
                    option.value = className;
                    option.textContent = className;
                    classNameDropdown.appendChild(option);
                });
        }
        
        // Render Teachers Grid
        function renderTeachers() {
            if (teachersData.length === 0) {
                teacherGrid.innerHTML = `
                    <div class="col-span-full text-center p-8">
                        <p class="text-gray-500">Tidak ada data guru tersedia.</p>
                    </div>
                `;
                return;
            }
            
            teacherGrid.innerHTML = teachersData.map((teacher, index) => `
                <div class="teacher-card bg-white rounded-lg shadow-md p-6 text-center cursor-pointer hover:shadow-lg" data-index="${index}">
                    <div class="w-32 h-32 mx-auto mb-4 rounded-full overflow-hidden shadow-md transform transition-transform hover:scale-105">
                        <img src="${teacher.foto}" alt="${teacher.nama}" class="w-full h-full object-cover" onerror="this.src='https://via.placeholder.com/150?text=${encodeURIComponent(teacher.nama)}'; this.onerror=null;">
                    </div>
                    <h3 class="text-lg font-semibold text-blue-800">${teacher.nama}</h3>
                </div>
            `).join('');
            
            // Add event listeners to teacher cards
            document.querySelectorAll('.teacher-card').forEach(card => {
                card.addEventListener('click', function() {
                    const index = this.getAttribute('data-index');
                    selectedTeacher = teachersData[index].nama;
                    
                    // Get unique classes for this teacher
                    const teacherClassNumbers = new Set();
studentsData.forEach(student => {
    if (student['nama guru'] === selectedTeacher) {
        const classNumber = extractClassNumber(student.kelas);
        if (classNumber) teacherClassNumbers.add(classNumber);
    }
});

// Render class options
renderClassOptions(Array.from(teacherClassNumbers));
                    
                    openClassModal();
                });
            });
        }
        
        // Render Class Options
        function renderClassOptions(classes) {
            if (classes.length === 0) {
                classOptions.innerHTML = `
                    <div class="col-span-2 text-center p-4">
                        <p class="text-gray-500">Tidak ada kelas tersedia untuk guru ini.</p>
                    </div>
                `;
                return;
            }
            
            // Sort classes numerically
            classes.sort((a, b) => parseInt(a) - parseInt(b));
            
            classOptions.innerHTML = classes.map(classNumber => `
                <button class="class-option bg-blue-50 hover:bg-blue-100 text-blue-800 font-medium py-4 px-6 rounded-lg transition duration-300 shadow-sm transform hover:scale-105" data-class="${classNumber}">
                    Kelas ${classNumber}
                </button>
            `).join('');
            
            // Add event listeners to class options
            document.querySelectorAll('.class-option').forEach(button => {
                button.addEventListener('click', function() {
                    selectedClass = this.getAttribute('data-class');
                    closeClassModal();
                    showPage(2);
                    
                    // Fetch latest attendance data before rendering students
                    fetchAttendanceData().then(() => {
                        renderStudents();
                        
                    });
                });
            });
        }  
        
        // Render Students List with new design
        async function renderStudents() {
            // Reset selected student status
            selectedStudentStatus = {};
            
            // Filter students based on selected teacher and class number
            const filteredStudents = studentsData.filter(student => {
                const studentClass = student.kelas;
                const studentClassNumber = extractClassNumber(studentClass);
                return student['nama guru'] === selectedTeacher && studentClassNumber === selectedClass;
            });
            
            // Sort students alphabetically by name
            filteredStudents.sort((a, b) => a['nama siswa'].localeCompare(b['nama siswa']));
            
            if (filteredStudents.length === 0) {
                studentList.innerHTML = `
                    <div class="col-span-full text-center p-8 bg-white rounded-lg shadow-md">
                        <p class="text-gray-500">Tidak ada data siswa untuk guru dan kelas yang dipilih.</p>
                    </div>
                `;
                return;
            }
            
            // Get today's date
            const today = formatDateForStorage();
            
            // Prepare HTML for student list
            let html = '';
            
            for (let i = 0; i < filteredStudents.length; i++) {
                const student = filteredStudents[i];
                const studentName = student['nama siswa'];
                
                // Check if attendance is already recorded for today
                const recordedData = getAttendanceRecord(studentName, today);
                const isRecorded = recordedData !== undefined;
                
                html += `
                    <div class="student-card">
                        <div class="student-header bg-blue-50">
                            <h3 class="font-medium text-blue-800">${studentName}</h3>
                            <p class="text-xs text-blue-600">${student.kelas}</p>
                        </div>
                        <div class="student-content">
                            ${isRecorded ? 
                                `<div class="flex flex-col">
                                    <div class="flex items-center justify-center mb-3">
                                        <span class="attendance-badge inline-flex items-center px-4 py-2 rounded-full text-sm font-medium ${
                                            recordedData.status === 'hadir' ? 'bg-green-100 text-green-800' : 
                                            recordedData.status === 'sakit' ? 'bg-yellow-100 text-yellow-800' : 
                                            recordedData.status === 'izin' ? 'bg-blue-100 text-blue-800' : 
                                            'bg-red-100 text-red-800'
                                        }">
                                            ${
                                                recordedData.status === 'hadir' ? '✅ Hadir' : 
                                                recordedData.status === 'sakit' ? '🤒 Sakit' : 
                                                recordedData.status === 'izin' ? '📝 Izin' : 
                                                '❌ Alpha'
                                            }
                                        </span>
                                    </div>
                                    <div class="note-container">
                                        <p class="text-sm text-gray-600 mb-1">Catatan:</p>
                                        <p class="text-gray-800">${recordedData.note || '-'}</p>
                                    </div>
                                </div>` :
                                `<div class="flex flex-col">
                                    <div class="attendance-options">
                                        <button class="attendance-option bg-green-100 hover:bg-green-200 text-green-800 px-3 py-1 rounded-full text-sm font-medium flex items-center shadow-sm" data-student="${studentName}" data-status="hadir">
                                            ✅ Hadir
                                        </button>
                                        <button class="attendance-option bg-yellow-100 hover:bg-yellow-200 text-yellow-800 px-3 py-1 rounded-full text-sm font-medium flex items-center shadow-sm" data-student="${studentName}" data-status="sakit">
                                            🤒 Sakit
                                        </button>
                                        <button class="attendance-option bg-blue-100 hover:bg-blue-200 text-blue-800 px-3 py-1 rounded-full text-sm font-medium flex items-center shadow-sm" data-student="${studentName}" data-status="izin">
                                            📝 Izin
                                        </button>
                                        <button class="attendance-option bg-red-100 hover:bg-red-200 text-red-800 px-3 py-1 rounded-full text-sm font-medium flex items-center shadow-sm" data-student="${studentName}" data-status="alpha">
                                            ❌ Alpha
                                        </button>
                                    </div>
                                    <div class="note-container" data-student="${studentName}" style="display: none;">
                                        <div class="mb-2">
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Catatan:</label>
                                            <textarea class="note-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" rows="2" placeholder=""></textarea>
                                        </div>
                                        <button class="save-btn w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-300 shadow-sm text-sm"
    data-student-index="${i}">
    Simpan
                                        </button>
                                    </div>
                                </div>`
                            }
                        </div>
                    </div>
                `;
            }
            
            studentList.innerHTML = html;
            
            // 1. Event listener untuk tombol status absensi (hadir/sakit/izin/alpha)
document.querySelectorAll('.attendance-option').forEach(button => {
    button.addEventListener('click', function() {
        const studentName = this.getAttribute('data-student');
        const status = this.getAttribute('data-status');
        const card = this.closest('.student-card');
        const noteContainer = card.querySelector('.note-container');
        const noteInput = card.querySelector('.note-input');

        // Check if this option is already selected
        const isSelected = this.classList.contains('selected-option');
        // Clear any previously selected options in this card
        card.querySelectorAll('.attendance-option').forEach(opt => {
            opt.classList.remove('selected-option');
        });
        // If the option was already selected, deselect it and hide note container
        if (isSelected) {
            noteContainer.style.display = 'none';
            delete selectedStudentStatus[studentName];
            return;
        }
        // Mark this option as selected
        this.classList.add('selected-option');
        selectedStudentStatus[studentName] = status;

        // Show note input with appropriate placeholder
        noteContainer.style.display = 'block';
        if (status === 'hadir') {
            noteInput.placeholder = 'Contoh: Buku 1 Halaman 1, Tahfidz Surah Al-Fatihah (Jangan Gunakan Enter)';
        } else if (status === 'sakit') {
            noteInput.placeholder = 'Contoh: Demam';
        } else if (status === 'izin') {
            noteInput.placeholder = 'Contoh: Acara Keluarga';
        } else if (status === 'alpha') {
            noteInput.placeholder = 'Tidak Perlu Diisi';
        }
            noteContainer.style.display = 'block'; // Semua Box Catatan Muncul, Jika Ingin Alpha diHide, Gunakan None
    });
});

// 2. Event listener untuk tombol simpan (save-btn) - HARUS DI LUAR blok atas
document.querySelectorAll('.save-btn').forEach((saveBtn) => {
    saveBtn.onclick = function() {
        const card = this.closest('.student-card');
        const noteInput = card.querySelector('.note-input');
        const note = noteInput.value.trim();
        const idx = parseInt(this.getAttribute('data-student-index'));
        const studentData = filteredStudents[idx];
        const status = selectedStudentStatus[studentData['nama siswa']];

        if (note === '') {
            showNotification('error', 'Catatan wajib diisi!');
            return;
        }

        saveAttendanceXHR(studentData['nama siswa'], status, note, studentData.kelas).then(success => {
            if (success) {
                const studentContent = card.querySelector('.student-content');
                studentContent.innerHTML = `
                    <div class="flex flex-col">
                        <div class="flex items-center justify-center mb-3">
                            <span class="attendance-badge inline-flex items-center px-4 py-2 rounded-full text-sm font-medium ${
                                status === 'hadir' ? 'bg-green-100 text-green-800' : 
                                status === 'sakit' ? 'bg-yellow-100 text-yellow-800' : 
                                status === 'izin' ? 'bg-blue-100 text-blue-800' :
                                'bg-red-100 text-red-800'
                            }">
                                ${
                                    status === 'hadir' ? '✅ Hadir' : 
                                    status === 'sakit' ? '🤒 Sakit' : 
                                    status === 'izin' ? '📝 Izin' :
                                    '❌ Alpha'
                                }
                            </span>
                        </div>
                        <div class="note-container">
                            <p class="text-sm text-gray-600 mb-1">Catatan:</p>
                            <p class="text-gray-800">${note || '-'}</p>
                        </div>
                    </div>
                `;
                showThankYouModal();
                setTimeout(() => {
                    hideThankYouModal();
                    setTimeout(() => {
                        showPage(1);
                    }, 500);
                }, 3000);
            } else {
                showNotification('error', 'Gagal menyimpan absensi. Silakan coba lagi.');
            }
        });
    };
});
            
            // Update current date
            currentDate.textContent = formatCurrentDate();
            
            // Update page 2 title with the format "Kelas [selectedClass] - [selectedTeacher]"
            classTitle.textContent = `Kelas ${selectedClass} - ${selectedTeacher}`;
        }
        
        // Filter attendance data based on selected filters
        function filterAttendanceData() {
            const month = filterMonth.value;
            const teacher = filterTeacher.value;
            const classNumber = filterClassNumber.value;
            const className = filterClassName.value;
            const kelasDipilih = filterClassNumber.value || filterClassName.value;
            const adminPanelDataAbsensi = document.querySelectorAll('.admin-panel.mb-8')[1]; // Panel kedua

            // --- Logika tampil/sembunyikan panel Data Absensi ---
    if (!kelasDipilih) {
        adminPanelDataAbsensi.style.display = 'none';

        // Opsional: tampilkan pesan jika panel disembunyikan
        let notice = document.getElementById('absensiNotice');
        if (!notice) {
            notice = document.createElement('div');
            notice.id = 'absensiNotice';
            notice.className = 'text-center text-gray-500 my-4';
            notice.innerText = 'Silakan pilih Kelas untuk melihat data absensi.';
            adminPanelDataAbsensi.parentNode.insertBefore(notice, adminPanelDataAbsensi);
        }
        notice.style.display = '';
        return; // Hentikan proses, jangan render data absensi
    } else {
        adminPanelDataAbsensi.style.display = '';
        // Sembunyikan pesan jika ada
        const notice = document.getElementById('absensiNotice');
        if (notice) notice.style.display = 'none';
    }
            
            // Check if we have enough filters to show the monthly report
            const showMonthlyReport = month && (classNumber || className);
            
            if (showMonthlyReport) {
                generateMonthlyReport(month, teacher, classNumber, className);
                reportContainer.style.display = 'block';
            } else {
                reportContainer.style.display = 'none';
            }
            
            // Tambahkan fungsi util di atas jika belum ada
function getTodayDate() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// Filter attendance data based on selected filters, TAPI hanya hari ini
filteredAttendanceData = attendanceData.filter(record => {
    // Hanya data absensi hari ini saja
    if (record.date !== getTodayDate()) return false;

    // Filter by month (optional, bisa dilewatkan jika hanya hari ini)
    if (month && !record.date.startsWith(`${new Date().getFullYear()}-${month}`)) return false;

    // Filter by teacher
    if (teacher && record.teacher !== teacher) return false;

    // PATCH: Prioritaskan exact match nama kelas
    if (className && className !== '') {
        if (record.class.toLowerCase() !== className.toLowerCase()) return false;
    } else if (classNumber && classNumber !== '') {
        const recordClassNumber = extractClassNumber(record.class);
        if (recordClassNumber !== classNumber) return false;
    }

    return true;
});

    console.log('filteredAttendanceData:', filteredAttendanceData);        
            
            // Sort by date (newest first)
            filteredAttendanceData.sort((a, b) => {
                if (a.date > b.date) return -1;
                if (a.date < b.date) return 1;
                return 0;
            });
            
            // Reset to first page
            currentPage = 1;
            
            // Update record count
            recordCount.textContent = filteredAttendanceData.length;
            
            // Render admin data
            renderAdminData();
        }
        
        // Generate Monthly Attendance Report
        function generateMonthlyReport(month, teacher, classNumber, className) {
    const year = new Date().getFullYear();
    const daysInMonth = getDaysInMonth(year, parseInt(month));
    const monthName = getMonthName(month);

    // Update info laporan
    reportMonth.textContent = `${monthName} ${year}`;
    reportTeacher.textContent = teacher || 'Semua Guru';
    reportClass.textContent = className || (classNumber ? `Kelas ${classNumber}` : 'Semua Kelas');

    let filteredStudents = studentsData;
    if (teacher) filteredStudents = filteredStudents.filter(student => student['nama guru'] === teacher);
    if (className && className !== '') {
        filteredStudents = filteredStudents.filter(student => student.kelas === className);
    } else if (classNumber && classNumber !== '') {
        filteredStudents = filteredStudents.filter(student => {
            const studentClassNumber = extractClassNumber(student.kelas);
            return studentClassNumber === classNumber;
        });
    }
    filteredStudents.sort((a, b) => a['nama siswa'].localeCompare(b['nama siswa']));

    let tableHTML = '<thead><tr>';
    tableHTML += '<th class="student-name">Nama Siswa</th>';
    for (let day = 1; day <= daysInMonth; day++) {
        tableHTML += `<th class="date-header">${day}</th>`;
    }
    tableHTML += '<th class="summary-header">H</th>';
    tableHTML += '<th class="summary-header">S</th>';
    tableHTML += '<th class="summary-header">I</th>';
    tableHTML += '<th class="summary-header">A</th>';
    tableHTML += '<th class="summary-header">%</th>';
    tableHTML += '</tr></thead><tbody>';

    let totalPercent = 0;
    const today = new Date();
    const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

    filteredStudents.forEach(student => {
        const studentName = student['nama siswa'];
        tableHTML += `<tr><td class="student-name">${studentName}</td>`;

        let hadirCount = 0, sakitCount = 0, izinCount = 0, alphaCount = 0;
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${month}-${String(day).padStart(2, '0')}`;

            // Lewati hari di masa depan
            if (dateStr > todayStr) {
                tableHTML += `<td></td>`;
                continue;
            }

            // Cari record absensi
            let record = null;
            if (className && className !== '') {
                record = attendanceData.find(r =>
                    r.date === dateStr &&
                    r.student === studentName &&
                    (teacher ? r.teacher === teacher : true) &&
                    r.class.toLowerCase() === className.toLowerCase()
                );
            } else if (classNumber && classNumber !== '') {
                record = attendanceData.find(r =>
                    r.date === dateStr &&
                    r.student === studentName &&
                    (teacher ? r.teacher === teacher : true) &&
                    extractClassNumber(r.class) === classNumber
                );
            } else {
                record = attendanceData.find(r =>
                    r.date === dateStr &&
                    r.student === studentName &&
                    (teacher ? r.teacher === teacher : true)
                );
            }

            let statusCode = '-';
            let statusClass = 'status--';

            if (record) {
                if (record.status === 'hadir') {
                    statusCode = 'H'; statusClass = 'status-H'; hadirCount++;
                } else if (record.status === 'sakit') {
                    statusCode = 'S'; statusClass = 'status-S'; sakitCount++;
                } else if (record.status === 'izin') {
                    statusCode = 'I'; statusClass = 'status-I'; izinCount++;
                } else if (record.status === 'alpha') {
                    statusCode = '-'; statusClass = 'status--'; alphaCount++;
                }
            } else {
                // Jika belum ada record, dan hari sudah lewat/hari ini, hitung sebagai alpha
                alphaCount++;
            }
            tableHTML += `<td class="${statusClass}">${statusCode}</td>`;
        }
        const totalDays = hadirCount + sakitCount + izinCount + alphaCount;
        const attendancePercentage = totalDays > 0 ? Math.round((hadirCount / totalDays) * 100) : 0;
        totalPercent += attendancePercentage;

        tableHTML += `<td class="summary-cell">${hadirCount}</td>`;
        tableHTML += `<td class="summary-cell">${sakitCount}</td>`;
        tableHTML += `<td class="summary-cell">${izinCount}</td>`;
        tableHTML += `<td class="summary-cell">${alphaCount}</td>`;
        tableHTML += `<td class="percentage-cell">${attendancePercentage}%</td>`;
        tableHTML += '</tr>';
    });

    tableHTML += '</tbody>';

    const averagePercent = filteredStudents.length > 0 ? (totalPercent / filteredStudents.length) : 0;
    const reportAverageElem = document.getElementById('reportAverage');
    if (reportAverageElem) {
        reportAverageElem.textContent = `${averagePercent.toFixed(2)}%`;
    }
    monthlyReportTable.innerHTML = tableHTML;
}
        
        // Render Admin Data
        function renderAdminData() {
            // Calculate pagination
            const startIndex = (currentPage - 1) * recordsPerPage;
            const endIndex = Math.min(startIndex + recordsPerPage, filteredAttendanceData.length);
            const currentRecords = filteredAttendanceData.slice(startIndex, endIndex);
            
            // Update page indicator
            pageIndicator.textContent = currentPage;
            
            // Update pagination buttons
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = endIndex >= filteredAttendanceData.length;
            
            if (currentRecords.length === 0) {
                adminDataList.innerHTML = `
                    <tr>
                        <td colspan="6" class="py-8 text-center text-gray-500">
                            Tidak ada data absensi tersedia.
                        </td>
                    </tr>
                `;
                return;
            }
            
            adminDataList.innerHTML = currentRecords.map(record => `
                <tr class="hover:bg-blue-50 transition-all">
                    <td class="py-3 px-4">${formatDateForDisplay(record.date)}</td>
                    <td class="py-3 px-4">${record.teacher}</td>
                    <td class="py-3 px-4">${record.class}</td>
                    <td class="py-3 px-4">${record.student}</td>
                    <td class="py-3 px-4">
                        <span class="status-badge ${record.status}">
                            ${
                                record.status === 'hadir' ? '✅ Hadir' : 
                                record.status === 'sakit' ? '🤒 Sakit' : 
                                record.status === 'izin' ? '📝 Izin' : 
                                '❌ Alpha'
                            }
                        </span>
                    </td>
                    <td class="py-3 px-4">${record.note || '-'}</td>
                </tr>
            `).join('');
        }
        
        // Export attendance report to PDF
function generateMonthlyReport(month, teacher, classNumber, className) {
    const year = new Date().getFullYear();
    const daysInMonth = getDaysInMonth(year, parseInt(month));
    const monthName = getMonthName(month);

    // Update report info
    reportMonth.textContent = `${monthName} ${year}`;
    reportTeacher.textContent = teacher || 'Semua Guru';
    reportClass.textContent = className || (classNumber ? `Kelas ${classNumber}` : 'Semua Kelas');

    // Get students based on filters
    let filteredStudents = studentsData;

    // Filter by teacher if specified
    if (teacher) {
        filteredStudents = filteredStudents.filter(student => student['nama guru'] === teacher);
    }

    // Filter by className jika dipilih
    if (className && className !== '') {
        filteredStudents = filteredStudents.filter(student => student.kelas === className);
    }
    // Jika tidak, filter by classNumber
    else if (classNumber && classNumber !== '') {
        filteredStudents = filteredStudents.filter(student => {
            const studentClassNumber = extractClassNumber(student.kelas);
            return studentClassNumber === classNumber;
        });
    }

    // Sort students alphabetically
    filteredStudents.sort((a, b) => a['nama siswa'].localeCompare(b['nama siswa']));

    // Generate table header
    let tableHTML = '<thead><tr>';
    tableHTML += '<th class="student-name">Nama Siswa</th>';

    // Add date columns
    for (let day = 1; day <= daysInMonth; day++) {
        tableHTML += `<th class="date-header">${day}</th>`;
    }

    // Add summary columns
    tableHTML += '<th class="summary-header">H</th>';
    tableHTML += '<th class="summary-header">S</th>';
    tableHTML += '<th class="summary-header">I</th>';
    tableHTML += '<th class="summary-header">A</th>';
    tableHTML += '<th class="summary-header">%</th>';
    tableHTML += '</tr></thead><tbody>';

    // --- TAMBAHAN: Variabel untuk hitung rata-rata kehadiran ---
    let totalPercent = 0;

    // Generate table rows for each student
    filteredStudents.forEach(student => {
        const studentName = student['nama siswa'];
        const studentClass = student.kelas;

        tableHTML += `<tr><td class="student-name">${studentName}</td>`;

        // Initialize counters for summary
        let hadirCount = 0;
        let sakitCount = 0;
        let izinCount = 0;
        let alphaCount = 0;

        // Add status for each day
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${month}-${String(day).padStart(2, '0')}`;
            const today = new Date();
            const currentDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            const dateToCheck = new Date(dateStr);

            // Skip future dates
            if (dateStr > currentDate) {
                tableHTML += `<td></td>`;
                continue;
            }

            // Find attendance record for this student on this date
            let record = null;

            // First try to find an exact match with class name if specified
            if (className && className !== '') {
                record = attendanceData.find(r => 
                    r.date === dateStr && 
                    r.student === studentName &&
                    (teacher ? r.teacher === teacher : true) &&
                    r.class.toLowerCase() === className.toLowerCase()
                );
            } else if (classNumber && classNumber !== '') {
                record = attendanceData.find(r => 
                    r.date === dateStr && 
                    r.student === studentName &&
                    (teacher ? r.teacher === teacher : true) &&
                    extractClassNumber(r.class) === classNumber
                );
            } else {
                record = attendanceData.find(r => 
                    r.date === dateStr && 
                    r.student === studentName &&
                    (teacher ? r.teacher === teacher : true)
                );
            }

            let statusCode = '-';
            let statusClass = 'status--';

            if (record) {
                if (record.status === 'hadir') {
                    statusCode = 'H';
                    statusClass = 'status-H';
                    hadirCount++;
                } else if (record.status === 'sakit') {
                    statusCode = 'S';
                    statusClass = 'status-S';
                    sakitCount++;
                } else if (record.status === 'izin') {
                    statusCode = 'I';
                    statusClass = 'status-I';
                    izinCount++;
                } else if (record.status === 'alpha') {
                    statusCode = '-';
                    statusClass = 'status--';
                    alphaCount++;
                }
            } else {
                // Alpha jika tanggal sudah lewat
                if (dateToCheck <= today) {
                    alphaCount++;
                }
            }

            tableHTML += `<td class="${statusClass}">${statusCode}</td>`;
        }

        // Calculate attendance percentage
        const totalDays = hadirCount + sakitCount + izinCount + alphaCount;
        const attendancePercentage = totalDays > 0 ? Math.round((hadirCount / totalDays) * 100) : 0;

        // --- TAMBAHAN: Akumulasi untuk rata-rata kelas ---
        totalPercent += attendancePercentage;

        // Add summary columns
        tableHTML += `<td class="summary-cell">${hadirCount}</td>`;
        tableHTML += `<td class="summary-cell">${sakitCount}</td>`;
        tableHTML += `<td class="summary-cell">${izinCount}</td>`;
        tableHTML += `<td class="summary-cell">${alphaCount}</td>`;
        tableHTML += `<td class="percentage-cell">${attendancePercentage}%</td>`;

        tableHTML += '</tr>';
    });

    tableHTML += '</tbody>';

    // --- TAMBAHAN: Hitung rata-rata kehadiran seluruh siswa berdasarkan filter ---
    const averagePercent = filteredStudents.length > 0 ? (totalPercent / filteredStudents.length) : 0;

    // --- TAMBAHAN: Tampilkan rata-rata kehadiran di bawah 'Bulan' ---
    // Pastikan di HTML ada elemen: <span id="reportAverage"></span>
    const reportAverageElem = document.getElementById('reportAverage');
    if (reportAverageElem) {
        reportAverageElem.textContent = `${averagePercent.toFixed(2)}%`;
    }

    // Update the table
    monthlyReportTable.innerHTML = tableHTML;
}

function formatTanggalCetak(dateObj) {
    const hari = String(dateObj.getDate()).padStart(2, '0');
    const bulanIndex = dateObj.getMonth(); // 0-11
    const tahun = dateObj.getFullYear();
    const namaBulan = [
        "Januari", "Februari", "Maret", "April", "Mei", "Juni",
        "Juli", "Agustus", "September", "Oktober", "November", "Desember"
    ][bulanIndex];
    return `${hari} ${namaBulan} ${tahun}`;
}
        
function printAttendanceReport() {
    // Ambil data yang sama persis seperti exportAttendanceToPDF
    const month = filterMonth.value;
    const teacher = filterTeacher.value;
    const classNumber = filterClassNumber.value;
    const className = filterClassName.value;
    const monthName = getMonthName(month);
    const year = new Date().getFullYear();
    const now = new Date();
    const tanggalCetak = formatTanggalCetak(now);
    const reportTeacherText = teacher || 'Semua Guru';
    const reportClassText = className || (classNumber ? `Kelas ${classNumber}` : 'Semua Kelas');

    let filteredStudents = studentsData;
    if (teacher) filteredStudents = filteredStudents.filter(student => student['nama guru'] === teacher);
    if (className) {
        filteredStudents = filteredStudents.filter(student => student.kelas.toLowerCase() === className.toLowerCase());
    } else if (classNumber) {
        filteredStudents = filteredStudents.filter(student => {
            const studentClassNumber = extractClassNumber(student.kelas);
            return studentClassNumber === classNumber;
        });
    }
    filteredStudents.sort((a, b) => a['nama siswa'].localeCompare(b['nama siswa']));
    const daysInMonth = getDaysInMonth(year, parseInt(month));

    // Table prep
    const headers = ['Nama Siswa'];
    for (let day = 1; day <= daysInMonth; day++) {
        headers.push(day.toString());
    }
    headers.push('H', 'S', 'I', 'A', '%');

    const rows = [];
    let totalPercent = 0;
    filteredStudents.forEach(student => {
        const studentName = student['nama siswa'];
        const row = [studentName];
        let hadirCount = 0, sakitCount = 0, izinCount = 0, alphaCount = 0;
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${month}-${String(day).padStart(2, '0')}`;
            const today = new Date();
            const currentDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            const dateToCheck = new Date(dateStr);
            if (dateStr > currentDate) {
                row.push('');
                continue;
            }
            let record = null;
            if (className && className !== '') {
                record = attendanceData.find(r =>
                    r.date === dateStr &&
                    r.student === studentName &&
                    (teacher ? r.teacher === teacher : true) &&
                    r.class.toLowerCase() === className.toLowerCase()
                );
            } else if (classNumber && classNumber !== '') {
                record = attendanceData.find(r =>
                    r.date === dateStr &&
                    r.student === studentName &&
                    (teacher ? r.teacher === teacher : true) &&
                    extractClassNumber(r.class) === classNumber
                );
            } else {
                record = attendanceData.find(r =>
                    r.date === dateStr &&
                    r.student === studentName &&
                    (teacher ? r.teacher === teacher : true)
                );
            }
            let statusCode = '-';
            if (record) {
                if (record.status === 'hadir') {
                    statusCode = 'H'; hadirCount++;
                } else if (record.status === 'sakit') {
                    statusCode = 'S'; sakitCount++;
                } else if (record.status === 'izin') {
                    statusCode = 'I'; izinCount++;
                } else if (record.status === 'alpha') {
                    statusCode = '-'; alphaCount++;
                }
            } else {
                if (dateToCheck <= today) alphaCount++;
            }
            row.push(statusCode);
        }
        const totalDays = hadirCount + sakitCount + izinCount + alphaCount;
        const attendancePercentage = totalDays > 0 ? Math.round((hadirCount / totalDays) * 100) : 0;
        totalPercent += attendancePercentage;
        row.push(hadirCount.toString(), sakitCount.toString(), izinCount.toString(), alphaCount.toString(), `${attendancePercentage}%`);
        rows.push(row);
    });
    const averagePercent = filteredStudents.length > 0 ? (totalPercent / filteredStudents.length) : 0;

    // Buat HTML laporan print (identik dengan PDF)
    let html = `
    <div id="print-area" style="font-family:helvetica,sans-serif;">
      <div style="text-align:center; margin-bottom:5px;">
        <h2 style="margin:0; font-size:16pt;">REKAP ABSENSI BULANAN GEMAR MENGAJI</h2>
        <div style="font-size:12pt;">SDIT Harapan Umat Karawang</div>
        <div style="font-size:10pt;">Jl. Pakuncen No. 01, Desa Sukaharja, Kec. Teluk Jambe Timur</div>
        <hr>
      </div>
      <div style="display:flex; justify-content:space-between; font-size:11pt; margin-bottom:1px;">
        <div>Guru: ${reportTeacherText}</div>
        <div>Kelas: ${reportClassText}</div>
        <div>Bulan: ${monthName} ${year}</div>
      </div>
      <div style="font-size:11pt; margin-bottom:10px;">Rata-rata Kehadiran: ${averagePercent.toFixed(2)}%</div>
      <table border="1" cellpadding="2" cellspacing="0" style="width:100%; font-size:9pt; border-collapse:collapse; margin-bottom:15px;">
        <thead>
          <tr>
            ${headers.map(h => `<th>${h}</th>`).join('')}
          </tr>
        </thead>
        <tbody>
          ${rows.map(row => `<tr>${row.map((cell, idx) => `<td style="text-align:${idx === 0 ? 'left' : 'center'}">${cell}</td>`).join('')}</tr>`).join('')}
        </tbody>
      </table>
      <div style="font-size:10pt; margin-bottom:15px;">Keterangan: H = Hadir, S = Sakit, I = Izin, - = Alpha</div>
      <div style="display:flex; justify-content:space-between; margin-top:40px; font-size:11pt;">
        <div style="width:40%; text-align:center;">
            Mengetahui,<br>
            Kepala SDIT<br><br><br>
            <div style="height:12px;"></div>
            <div style="margin-top:15px;">(<span style="border-bottom:2px dotted #000; padding:0 30px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>)</div>
        </div>
        <div style="width:40%; text-align:center;">
            Karawang, ${tanggalCetak}<br><br>
            Guru Bidang Studi<br><br><br>
            <div style="height:12px;"></div>
            <div style="margin-top:15px;">(<span style="border-bottom:2px dotted #000; padding:0 30px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>)</div>
        </div>
        </div>
    </div>
    `;

    // Buat window baru untuk print
    let win = window.open('', 'PrintReport', 'width=1000,height=700');
    win.document.write('<html><head><title>Cetak Rekap Absensi</title>');
    win.document.write('<style>@media print { #print-area { page-break-inside:avoid; width:297mm; min-height:210mm;} table{font-size:9pt;} }</style>');
    win.document.write('</head><body>' + html + '</body></html>');
    win.document.close();
    win.focus();
    setTimeout(() => win.print(), 500); // beri waktu render
}
        
// ---------------------------
// Tambahkan di fungsi export PDF
// ---------------------------
function exportAttendanceToPDF() {
    const { jsPDF } = window.jspdf;

    // Get report data
    const month = filterMonth.value;
    const teacher = filterTeacher.value;
    const classNumber = filterClassNumber.value;
    const className = filterClassName.value;

    const monthName = getMonthName(month);
    const year = new Date().getFullYear();
    const now = new Date();
    const tanggalCetak = `${now.getDate()}/${now.getMonth()+1}/${now.getFullYear()}`;
    const reportTeacherText = teacher || 'Semua Guru';
    const reportClassText = className || (classNumber ? `Kelas ${classNumber}` : 'Semua Kelas');

    let filteredStudents = studentsData;
    if (teacher) filteredStudents = filteredStudents.filter(student => student['nama guru'] === teacher);
    if (className) {
        filteredStudents = filteredStudents.filter(student => student.kelas.toLowerCase() === className.toLowerCase());
    } else if (classNumber) {
        filteredStudents = filteredStudents.filter(student => {
            const studentClassNumber = extractClassNumber(student.kelas);
            return studentClassNumber === classNumber;
        });
    }
    filteredStudents.sort((a, b) => a['nama siswa'].localeCompare(b['nama siswa']));
    const daysInMonth = getDaysInMonth(year, parseInt(month));

    // Table prep
    const headers = ['Nama Siswa'];
    for (let day = 1; day <= daysInMonth; day++) {
        headers.push(day.toString());
    }
    headers.push('H', 'S', 'I', 'A', '%');

    const rows = [];
    let totalPercent = 0;

    filteredStudents.forEach(student => {
        const studentName = student['nama siswa'];
        const row = [studentName];

        let hadirCount = 0;
        let sakitCount = 0;
        let izinCount = 0;
        let alphaCount = 0;

        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${month}-${String(day).padStart(2, '0')}`;
            const today = new Date();
            const currentDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            const dateToCheck = new Date(dateStr);

            if (dateStr > currentDate) {
                row.push('');
                continue;
            }

            let record = null;
            if (className && className !== '') {
                record = attendanceData.find(r =>
                    r.date === dateStr &&
                    r.student === studentName &&
                    (teacher ? r.teacher === teacher : true) &&
                    r.class.toLowerCase() === className.toLowerCase()
                );
            } else if (classNumber && classNumber !== '') {
                record = attendanceData.find(r =>
                    r.date === dateStr &&
                    r.student === studentName &&
                    (teacher ? r.teacher === teacher : true) &&
                    extractClassNumber(r.class) === classNumber
                );
            } else {
                record = attendanceData.find(r =>
                    r.date === dateStr &&
                    r.student === studentName &&
                    (teacher ? r.teacher === teacher : true)
                );
            }

            let statusCode = '-';
            if (record) {
                if (record.status === 'hadir') {
                    statusCode = 'H';
                    hadirCount++;
                } else if (record.status === 'sakit') {
                    statusCode = 'S';
                    sakitCount++;
                } else if (record.status === 'izin') {
                    statusCode = 'I';
                    izinCount++;
                } else if (record.status === 'alpha') {
                    statusCode = '-';
                    alphaCount++;
                }
            } else {
                if (dateToCheck <= today) {
                    alphaCount++;
                }
            }
            row.push(statusCode);
        }

        const totalDays = hadirCount + sakitCount + izinCount + alphaCount;
        const attendancePercentage = totalDays > 0 ? Math.round((hadirCount / totalDays) * 100) : 0;
        totalPercent += attendancePercentage;

        row.push(hadirCount.toString());
        row.push(sakitCount.toString());
        row.push(izinCount.toString());
        row.push(alphaCount.toString());
        row.push(`${attendancePercentage}%`);

        rows.push(row);
    });

    // Hitung rata-rata kehadiran untuk PDF
    const averagePercent = filteredStudents.length > 0 ? (totalPercent / filteredStudents.length) : 0;

    // Create PDF document
    const doc = new jsPDF('l', 'mm', 'a4');
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();

    // Header
    doc.setFontSize(16);
    doc.text('REKAP ABSENSI BULANAN GEMAR MENGAJI', pageWidth/2, 18, { align: 'center' });
    doc.setFontSize(12);
    doc.text('SDIT Harapan Umat Karawang', pageWidth/2, 26, { align: 'center' });
    doc.setFontSize(10);
    doc.text('Jl. Pakuncen No. 01, Desa Sukaharja, Kec. Teluk Jambe Timur', pageWidth/2, 32, { align: 'center' });
    doc.line(15, 36, pageWidth-15, 36);

    // Info bar
    let infoY = 44;
    doc.setFontSize(11);
    doc.text(`Guru: ${reportTeacherText}`, 20, infoY);
    doc.text(`Kelas: ${reportClassText}`, pageWidth/2 - 25, infoY);
    doc.text(`Bulan: ${monthName} ${year}`, pageWidth-65, infoY);
    doc.text(`Rata-rata Kehadiran: ${averagePercent.toFixed(2)}%`, 20, infoY + 8);

    // Tabel
    doc.autoTable({
        head: [headers],
        body: rows,
        startY: infoY + 15,
        theme: 'grid',
        margin: { left: 10, right: 10 },
        tableWidth: 'auto',
        styles: {
            fontSize: 7,
            cellPadding: 1,
            halign: 'center',
            valign: 'middle'
        },
        headStyles: {
            fillColor: [255, 255, 255],
            textColor: [0, 0, 0],
            fontStyle: 'bold'
        },
        columnStyles: {
            0: { cellWidth: 40, halign: 'left' },
            // ... kolom lain seperti sebelumnya ...
        },
        pageBreak: 'auto',
        didDrawPage: function (data) {
    const doc = data.doc; // jsPDF doc instance
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    let footerHeight = 30; // tinggi footer
    let yFooter = pageHeight - footerHeight;

    //Just Footer
    doc.setFontSize(11);
    doc.text('Mengetahui,', 30, yFooter);
    doc.text('Kepala Sekolah', 30, yFooter + 7);
    doc.text('(.............................)', 30, yFooter + 25);

    doc.text(`Karawang, ${tanggalCetak}`, pageWidth - 67, yFooter);
    doc.line(pageWidth - 77, yFooter + 28, pageWidth - 17, yFooter + 28);
},
    });
    
    // Save PDF
    const filename = `rekap_absensi_${monthName.toLowerCase()}_${year}_${reportClassText.replace(/\s+/g, '_').toLowerCase()}.pdf`;
    doc.save(filename);

    showNotification('success', 'Laporan berhasil diunduh dalam format PDF!');
}        
        // Show Notification
        function showNotification(type, message) {
            const notificationContent = document.getElementById('notificationContent');
            
            // Set notification content based on type
            if (type === 'success') {
                notificationContent.innerHTML = `
                    <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 w-full">
                        <div class="flex items-center">
                            <svg class="h-6 w-6 text-green-500 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                            </svg>
                            <p>${message}</p>
                        </div>
                    </div>
                `;
            } else if (type === 'info') {
                notificationContent.innerHTML = `
                    <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 w-full">
                        <div class="flex items-center">
                            <svg class="h-6 w-6 text-blue-500 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <p>${message}</p>
                        </div>
                    </div>
                `;
            } else {
                notificationContent.innerHTML = `
                    <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 w-full">
                        <div class="flex items-center">
                            <svg class="h-6 w-6 text-red-500 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                            <p>${message}</p>
                        </div>
                    </div>
                `;
            }
            
            // Show notification
            notification.classList.add('show');
            
            // Hide notification after 3 seconds
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // Show Thank You Modal
        function showThankYouModal() {
            thankYouModal.classList.add('show');
        }
        
        // Hide Thank You Modal
        function hideThankYouModal() {
            thankYouModal.classList.remove('show');
        }
        
        // Show Page
        function showPage(pageNumber) {
            // Hide all pages
            page1.classList.add('hidden');
            page2.classList.add('hidden');
            page3.classList.add('hidden');
            
            // Show selected page
            if (pageNumber === 1) {
                page1.classList.remove('hidden');
                page1.classList.add('fade-in');

                fetchTeachers();
                
                // Clear auto-submit timer when leaving page 2
                if (autoSubmitTimer) {
                    clearTimeout(autoSubmitTimer);
                    autoSubmitTimer = null;
                }
            } else if (pageNumber === 2) {
                page2.classList.remove('hidden');
                page2.classList.add('fade-in');

                // selalu ambil data absen terbaru
                fetchAttendanceData().then(() => {
                    renderStudents();
                });
            
                // Setup auto-submit timer for alpha attendance
            } else if (pageNumber === 3) {
                page3.classList.remove('hidden');
                page3.classList.add('fade-in');
                
                // Set default date to today
                if (!filterMonth.value) {
                    const today = new Date();
                    const month = String(today.getMonth() + 1).padStart(2, '0');
                    filterMonth.value = month;
                }
                
                // Fetch data only once when page 3 is opened
                if (!adminDataFetched) {
                    Promise.all([
                        fetchAttendanceData(),
                        fetchStudents(),
                        fetchTeachers()
                    ]).then(() => {
                        adminDataFetched = true;
                        filterAttendanceData();
                    });
                } else {
                    filterAttendanceData();
                }
            }
        }
        
        // Open Login Modal
        function openLoginModal() {
            loginModal.style.display = 'block';
            setTimeout(() => {
                loginModal.classList.add('show');
                document.getElementById('username').focus();
            }, 10);
        }
        
        // Close Login Modal
        function closeLoginModal() {
            loginModal.classList.remove('show');
            setTimeout(() => {
                loginModal.style.display = 'none';
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
            }, 300);
        }
        
        // Open Class Modal
        function openClassModal() {
            classModal.style.display = 'block';
            setTimeout(() => {
                classModal.classList.add('show');
            }, 10);
        }
        
        // Close Class Modal
        function closeClassModal() {
            classModal.classList.remove('show');
            setTimeout(() => {
                classModal.style.display = 'none';
            }, 300);
        }
        
        // Start refresh animation
        function startRefreshAnimation(button) {
            const icon = button.querySelector('.refresh-icon');
            icon.classList.add('spinning');
        }
        
        // Stop refresh animation
        function stopRefreshAnimation(button) {
            const icon = button.querySelector('.refresh-icon');
            icon.classList.remove('spinning');
        }
        
        // Initialize the application
        async function initApp() {
            try {
                // Fetch all data in parallel
                await Promise.all([
                    fetchTeachers(),
                    fetchStudents(),
                    fetchAttendanceData()
                ]);
                
            } catch (error) {
                console.error('Error initializing app:', error);
                showNotification('error', 'Terjadi kesalahan saat memuat aplikasi. Silakan refresh halaman.');
            }
        }
        
        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize the application
            initApp();
            
            // Login button
            document.getElementById('loginBtn').addEventListener('click', function() {
                if (isAdmin) {
                    showPage(3);
                } else {
                    openLoginModal();
                }
            });
            
            // Close login modal
            document.getElementById('closeLoginModal').addEventListener('click', closeLoginModal);
            
            // Login form submission
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                if (username === 'admin' && password === 'gurutahta') {
                    isAdmin = true;
                    showNotification('success', 'Login berhasil!');
                    closeLoginModal();
                    showPage(3);
                    
                    // Update login button text
                    document.getElementById('loginBtn').textContent = 'Panel Admin';
                } else {
                    showNotification('error', 'Username atau password salah!');
                }
            });
            
            // Close class modal
            document.getElementById('closeClassModal').addEventListener('click', closeClassModal);
            
            // Back to home button
            document.getElementById('backToHome').addEventListener('click', function() {
                showPage(1);
            });
            
            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', function() {
                isAdmin = false;
                adminDataFetched = false;
                document.getElementById('loginBtn').textContent = 'Login Admin';
                showPage(1);
                showNotification('success', 'Logout berhasil!');
            });
            
            // Filter button
            document.getElementById('filterBtn').addEventListener('click', filterAttendanceData);
            
            // Export PDF button
            document.getElementById('exportPdfBtn').addEventListener('click', exportAttendanceToPDF);
            
            // Print report button
            document.getElementById('printReportBtn').addEventListener('click', function() {
                printAttendanceReport();
            });
            
            // Pagination buttons
            document.getElementById('prevPage').addEventListener('click', function() {
                if (currentPage > 1) {
                    currentPage--;
                    renderAdminData();
                }
            });
            
            document.getElementById('nextPage').addEventListener('click', function() {
                if ((currentPage * recordsPerPage) < filteredAttendanceData.length) {
                    currentPage++;
                    renderAdminData();
                }
            });
            
            // Close modal when clicking outside
            window.addEventListener('click', function(e) {
                if (e.target === loginModal) {
                    closeLoginModal();
                }
                if (e.target === classModal) {
                    closeClassModal();
                }
            });
            
            // Refresh students button
            refreshStudentsBtn.addEventListener('click', function() {
                startRefreshAnimation(this);
                
                // Fetch latest attendance data and then refresh students
                Promise.all([
                    fetchAttendanceData(),
                    fetchStudents()
                ]).then(() => {
                    renderStudents();
                    showNotification('success', 'Data siswa berhasil diperbarui!');
                    stopRefreshAnimation(this);
                }).catch(error => {
                    console.error('Error refreshing data:', error);
                    showNotification('error', 'Gagal memperbarui data. Silakan coba lagi.');
                    stopRefreshAnimation(this);
                });
            });
            
            // Refresh admin data button
            refreshAdminDataBtn.addEventListener('click', function() {
                startRefreshAnimation(this);
                
                // Fetch latest attendance data and refresh admin view
                Promise.all([
                    fetchAttendanceData(),
                    fetchStudents(),
                    fetchTeachers()
                ]).then(() => {
                    filterAttendanceData();
                    showNotification('success', 'Data berhasil diperbarui!');
                    stopRefreshAnimation(this);
                }).catch(error => {
                    console.error('Error refreshing data:', error);
                    showNotification('error', 'Gagal memperbarui data. Silakan coba lagi.');
                    stopRefreshAnimation(this);
                });
            });
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'966457682771ea76',t:'MTc1MzcwNTM0MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>

