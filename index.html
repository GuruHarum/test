<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Daftar Hadir Gemar Mengaji - SDIT Harapan Umat Karawang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
        }
        
        .modal-overlay {
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }
        
        .modal-content {
            transform: scale(0.9);
            transition: all 0.3s ease;
        }
        
        .modal-overlay.show .modal-content {
            transform: scale(1);
        }
        
        .teacher-card {
            transition: all 0.3s ease;
        }
        
        .teacher-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        @media (hover: none) and (pointer: coarse) {
            .teacher-card:hover {
                transform: none;
            }
            .teacher-card:active {
                transform: scale(0.98);
            }
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .class-button {
            transition: all 0.3s ease;
        }
        
        .class-button:hover {
            transform: scale(1.05);
        }
        
        .page-transition {
            opacity: 1;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            transform: translateX(0);
        }
        
        .page-transition.fade-out {
            opacity: 0;
            transform: translateX(-50px);
        }
        
        .page-transition.fade-in {
            opacity: 0;
            transform: translateX(50px);
        }
        
        .page-transition.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .thank-you-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.7);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2.5rem 3.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            opacity: 0;
            transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .thank-you-popup.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
        
        .thank-you-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(8px);
            z-index: 999;
            opacity: 0;
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .thank-you-popup-overlay.show {
            opacity: 1;
        }
        
        /* Monthly Grid Table Styles */
        #monthlyAttendanceTable {
            border-collapse: separate;
            border-spacing: 0;
        }
        
        #monthlyAttendanceTable th:first-child,
        #monthlyAttendanceTable td:first-child {
            position: sticky;
            left: 0;
            z-index: 10;
            box-shadow: 2px 0 5px -2px rgba(0, 0, 0, 0.1);
        }
        
        #monthlyAttendanceTable th {
            background-color: #f9fafb;
            border-bottom: 2px solid #e5e7eb;
        }
        
        #monthlyAttendanceTable td {
            border-right: 1px solid #f3f4f6;
            border-bottom: 1px solid #f3f4f6;
        }
        
        #monthlyAttendanceTable tbody tr:hover td:first-child {
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Main Page Container -->
    <div id="mainPage" class="page-transition">
        <!-- Header -->
        <header class="gradient-bg text-white shadow-lg">
            <div class="container mx-auto px-4 py-4">
                <div class="flex flex-col sm:flex-row items-center justify-between space-y-4 sm:space-y-0">
                    <div class="flex items-center space-x-3 sm:space-x-4">
                        <img src="https://iili.io/FjF61ou.png" alt="Logo SDIT" class="h-12 w-12 sm:h-16 sm:w-16 object-cover rounded-full border-2 border-white shadow-lg">
                        <div class="text-center sm:text-left">
                            <h1 class="text-lg sm:text-2xl font-bold">SDIT Harapan Umat Karawang</h1>
                            <p class="text-xs sm:text-sm opacity-90 hidden sm:block">Jl. Pakuncen No. 01, Desa Sukaharja, Kec. Teluk Jambe Timur</p>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="showLoginModal()" class="bg-white text-purple-600 px-4 sm:px-6 py-2 rounded-lg font-semibold hover:bg-gray-100 transition-colors text-sm sm:text-base" id="loginButton">
                            Login
                        </button>
                        <button onclick="showAdminPage()" class="bg-green-500 text-white px-4 sm:px-6 py-2 rounded-lg font-semibold hover:bg-green-600 transition-colors text-sm sm:text-base hidden" id="adminButton">
                            Dashboard
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-6 sm:py-8">
            <div class="text-center mb-8 sm:mb-12">
                <h2 class="text-2xl sm:text-4xl font-bold text-gray-800 mb-2 sm:mb-4">Daftar Hadir Gemar Mengaji</h2>
                <p class="text-gray-600 text-base sm:text-lg px-4">Pilih guru untuk melanjutkan ke daftar hadir</p>
            </div>

            <!-- Teachers Grid -->
            <div id="teachersGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 sm:gap-6">
                <!-- Teachers will be loaded here -->
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-800 text-white py-6 mt-16">
            <div class="container mx-auto px-4 text-center">
                <p>&copy; Hak Cipta SDIT Harapan Umat Karawang</p>
            </div>
        </footer>
    </div>

    <!-- Thank You Popup -->
    <div id="thankYouOverlay" class="thank-you-popup-overlay hidden"></div>
    <div id="thankYouPopup" class="thank-you-popup hidden">
        <div class="text-center">
            <div class="text-4xl mb-4">üôè</div>
            <h3 class="text-2xl font-bold mb-2">Terimakasih Ayah/Bunda</h3>
            <p class="text-lg opacity-90">Absensi telah berhasil disimpan</p>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl p-6 sm:p-8 modal-content w-full max-w-sm sm:max-w-md mx-auto relative">
            <button onclick="hideLoginModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-xl font-bold">
                √ó
            </button>
            <h3 class="text-xl sm:text-2xl font-bold text-center mb-6 text-gray-800">Login Admin</h3>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Username</label>
                    <input type="text" id="username" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-500 text-base" required>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                    <input type="password" id="password" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-500 text-base" required>
                </div>
                <button type="submit" class="w-full gradient-bg text-white py-3 px-4 rounded-lg font-semibold hover:opacity-90 transition-opacity text-base">
                    Masuk
                </button>
            </form>
        </div>
    </div>

    <!-- Class Selection Modal -->
    <div id="classModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl p-6 sm:p-8 modal-content w-full max-w-sm sm:max-w-md mx-auto relative">
            <button onclick="hideClassModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-xl font-bold">
                √ó
            </button>
            <h3 class="text-xl sm:text-2xl font-bold text-center mb-6 text-gray-800">Pilih Kelas</h3>
            <div class="grid grid-cols-2 gap-3 sm:gap-4">
                <button onclick="selectClass(1)" class="class-button bg-blue-500 text-white py-3 sm:py-4 px-4 sm:px-6 rounded-lg font-semibold hover:bg-blue-600 text-sm sm:text-base">
                    Kelas 1
                </button>
                <button onclick="selectClass(2)" class="class-button bg-green-500 text-white py-3 sm:py-4 px-4 sm:px-6 rounded-lg font-semibold hover:bg-green-600 text-sm sm:text-base">
                    Kelas 2
                </button>
                <button onclick="selectClass(3)" class="class-button bg-yellow-500 text-white py-3 sm:py-4 px-4 sm:px-6 rounded-lg font-semibold hover:bg-yellow-600 text-sm sm:text-base">
                    Kelas 3
                </button>
                <button onclick="selectClass(4)" class="class-button bg-red-500 text-white py-3 sm:py-4 px-4 sm:px-6 rounded-lg font-semibold hover:bg-red-600 text-sm sm:text-base">
                    Kelas 4
                </button>
                <button onclick="selectClass(5)" class="class-button bg-purple-500 text-white py-3 sm:py-4 px-4 sm:px-6 rounded-lg font-semibold hover:bg-purple-600 text-sm sm:text-base">
                    Kelas 5
                </button>
                <button onclick="selectClass(6)" class="class-button bg-indigo-500 text-white py-3 sm:py-4 px-4 sm:px-6 rounded-lg font-semibold hover:bg-indigo-600 text-sm sm:text-base">
                    Kelas 6
                </button>
            </div>
        </div>
    </div>



    <!-- Page 2: Attendance Form -->
    <div id="attendancePage" class="hidden min-h-screen bg-gray-50 page-transition">
        <header class="gradient-bg text-white shadow-lg">
            <div class="container mx-auto px-4 py-4">
                <div class="flex flex-col sm:flex-row items-center justify-between space-y-4 sm:space-y-0">
                    <div class="flex items-center space-x-3 sm:space-x-4">
                        <img src="https://iili.io/FjF61ou.png" alt="Logo SDIT" class="h-12 w-12 sm:h-16 sm:w-16 object-cover rounded-full border-2 border-white shadow-lg">
                        <div class="text-center sm:text-left">
                            <h1 class="text-lg sm:text-2xl font-bold">SDIT Harapan Umat Karawang</h1>
                            <p class="text-xs sm:text-sm opacity-90 hidden sm:block">Jl. Pakuncen No. 01, Desa Sukaharja, Kec. Teluk Jambe Timur</p>
                        </div>
                    </div>
                    <button onclick="goBack()" class="bg-white text-purple-600 px-4 sm:px-6 py-2 rounded-lg font-semibold hover:bg-gray-100 transition-colors text-sm sm:text-base">
                        Kembali
                    </button>
                </div>
            </div>
        </header>

        <main class="container mx-auto px-4 py-6 sm:py-8">
            <div class="text-center mb-6 sm:mb-8">
                <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2">Daftar Hadir Gemar Mengaji</h2>
                <p class="text-base sm:text-lg text-gray-600" id="classInfo">Kelas - Guru</p>
                <p class="text-sm text-gray-500" id="currentDate"></p>
            </div>

            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-4 sm:p-6">
                    <h3 class="text-lg sm:text-xl font-semibold">Daftar Siswa</h3>
                </div>
                
                <div class="p-4 sm:p-6">
                    <div id="studentsContainer" class="space-y-4">
                        <!-- Students will be loaded here -->
                    </div>
                    

                </div>
            </div>
        </main>

        <footer class="bg-gray-800 text-white py-6 mt-16">
            <div class="container mx-auto px-4 text-center">
                <p>&copy; Hak Cipta SDIT Harapan Umat Karawang</p>
            </div>
        </footer>
    </div>

    <!-- Page 3: Admin Dashboard -->
    <div id="adminPage" class="hidden min-h-screen bg-gray-50 page-transition">
        <header class="gradient-bg text-white shadow-lg">
            <div class="container mx-auto px-4 py-4">
                <div class="flex flex-col sm:flex-row items-center justify-between space-y-4 sm:space-y-0">
                    <div class="flex items-center space-x-3 sm:space-x-4">
                        <img src="https://iili.io/FjF61ou.png" alt="Logo SDIT" class="h-12 w-12 sm:h-16 sm:w-16 object-cover rounded-full border-2 border-white shadow-lg">
                        <div class="text-center sm:text-left">
                            <h1 class="text-lg sm:text-2xl font-bold">SDIT Harapan Umat Karawang</h1>
                            <p class="text-xs sm:text-sm opacity-90 hidden sm:block">Jl. Pakuncen No. 01, Desa Sukaharja, Kec. Teluk Jambe Timur</p>
                        </div>
                    </div>
                    <div class="flex space-x-2 sm:space-x-3">
                        <button onclick="goBackToMain()" class="bg-white text-purple-600 px-4 sm:px-6 py-2 rounded-lg font-semibold hover:bg-gray-100 transition-colors text-sm sm:text-base">
                            Kembali
                        </button>
                        <button onclick="logout()" class="bg-red-500 text-white px-4 sm:px-6 py-2 rounded-lg font-semibold hover:bg-red-600 transition-colors text-sm sm:text-base">
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main class="container mx-auto px-4 py-6 sm:py-8">
            <div class="text-center mb-6 sm:mb-8">
                <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2 sm:mb-4">Rekap Absensi Gemar Mengaji</h2>
                <p class="text-gray-600 text-base sm:text-lg px-4">Kelola dan pantau data kehadiran siswa</p>
            </div>

            <!-- Filter Section -->
            <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 mb-6 sm:mb-8">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4">
                    <h3 class="text-lg sm:text-xl font-semibold text-gray-800 mb-2 sm:mb-0">Filter Data</h3>
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3">
                        <button onclick="refreshDataFromGoogleSheets()" class="bg-purple-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-purple-700 transition-colors text-sm flex items-center space-x-2">
                            <span>üîÑ</span>
                            <span>Refresh Data</span>
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Guru</label>
                        <select id="filterTeacher" onchange="filterAttendanceData()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-500 text-base">
                            <option value="">Semua Guru</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Kelas</label>
                        <select id="filterClass" onchange="filterAttendanceData()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-500 text-base">
                            <option value="">Semua Kelas</option>
                            <option value="1">Kelas 1</option>
                            <option value="2">Kelas 2</option>
                            <option value="3">Kelas 3</option>
                            <option value="4">Kelas 4</option>
                            <option value="5">Kelas 5</option>
                            <option value="6">Kelas 6</option>
                        </select>
                    </div>
                    <div class="sm:col-span-2 lg:col-span-1">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Bulan</label>
                        <input type="month" id="filterMonth" onchange="filterAttendanceData()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-500 text-base">
                    </div>
                </div>
            </div>

            <!-- Loading Indicator -->
            <div id="loadingIndicator" class="hidden bg-white rounded-xl shadow-lg p-6 mb-6 text-center">
                <div class="flex items-center justify-center space-x-3">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
                    <span class="text-lg font-medium text-gray-700">Memuat data dari Google Sheets...</span>
                </div>
            </div>

            <!-- Data Status Indicator -->
            <div id="dataStatusIndicator" class="hidden bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-6">
                <div class="flex items-center space-x-3">
                    <span class="text-yellow-600">‚ö†Ô∏è</span>
                    <span class="text-yellow-800 font-medium">Mode Offline - Menggunakan data lokal</span>
                    <button onclick="refreshDataFromGoogleSheets()" class="ml-auto bg-yellow-600 text-white px-3 py-1 rounded text-sm hover:bg-yellow-700">
                        Coba Lagi
                    </button>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-6 sm:mb-8">
                <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 text-center">
                    <div class="text-2xl sm:text-3xl font-bold text-green-600" id="totalHadir">0</div>
                    <p class="text-gray-600 mt-2 text-sm sm:text-base">üòä Hadir</p>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 text-center">
                    <div class="text-2xl sm:text-3xl font-bold text-yellow-600" id="totalSakit">0</div>
                    <p class="text-gray-600 mt-2 text-sm sm:text-base">ü§í Sakit</p>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 text-center">
                    <div class="text-2xl sm:text-3xl font-bold text-blue-600" id="totalIzin">0</div>
                    <p class="text-gray-600 mt-2 text-sm sm:text-base">üôè Izin</p>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 text-center">
                    <div class="text-2xl sm:text-3xl font-bold text-red-600" id="totalAlpha">0</div>
                    <p class="text-gray-600 mt-2 text-sm sm:text-base">‚ùå Alpha</p>
                </div>
            </div>

            <!-- Monthly Grid Table (shown when both teacher and class are filtered) -->
            <div id="monthlyGridTable" class="bg-white rounded-xl shadow-lg overflow-hidden mb-6 hidden">
                <div class="bg-gradient-to-r from-green-600 to-teal-600 text-white p-4 sm:p-6">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                        <div>
                            <h3 class="text-lg sm:text-xl font-semibold">Rekap Bulanan Absensi</h3>
                            <p class="text-sm opacity-90 mt-1" id="monthlyTableInfo">Guru - Kelas</p>
                        </div>
                        <div class="mt-2 sm:mt-0 flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3">
                            <span class="text-xs bg-white bg-opacity-20 px-2 py-1 rounded">H=Hadir, S=Sakit, I=Izin, -=Alpha</span>
                            <button onclick="downloadMonthlyExcel()" class="bg-green-600 text-white px-3 py-1 rounded text-xs font-semibold hover:bg-green-700 transition-colors flex items-center space-x-1">
                                <span>üìä</span>
                                <span>Download Excel</span>
                            </button>
                            <button onclick="printMonthlyTable()" class="bg-blue-600 text-white px-3 py-1 rounded text-xs font-semibold hover:bg-blue-700 transition-colors flex items-center space-x-1">
                                <span>üñ®Ô∏è</span>
                                <span>Cetak</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="p-4 sm:p-6">
                    <div class="overflow-x-auto">
                        <table class="w-full table-auto min-w-full" id="monthlyAttendanceTable">
                            <!-- Monthly grid will be generated here -->
                        </table>
                    </div>
                </div>
            </div>

            <!-- Regular Attendance Table -->
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-4 sm:p-6">
                    <h3 class="text-lg sm:text-xl font-semibold">Data Absensi Siswa</h3>
                </div>
                
                <div class="p-4 sm:p-6">
                    <div class="overflow-x-auto">
                        <table class="w-full table-auto min-w-full">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-2 sm:px-4 py-3 text-left text-xs sm:text-sm font-semibold text-gray-700">No</th>
                                    <th class="px-2 sm:px-4 py-3 text-left text-xs sm:text-sm font-semibold text-gray-700">Nama Siswa</th>
                                    <th class="px-2 sm:px-4 py-3 text-left text-xs sm:text-sm font-semibold text-gray-700 hidden sm:table-cell">Kelas</th>
                                    <th class="px-2 sm:px-4 py-3 text-left text-xs sm:text-sm font-semibold text-gray-700 hidden md:table-cell">Guru</th>
                                    <th class="px-2 sm:px-4 py-3 text-left text-xs sm:text-sm font-semibold text-gray-700">Status</th>
                                    <th class="px-2 sm:px-4 py-3 text-left text-xs sm:text-sm font-semibold text-gray-700 hidden lg:table-cell">Catatan</th>
                                    <th class="px-2 sm:px-4 py-3 text-left text-xs sm:text-sm font-semibold text-gray-700 hidden sm:table-cell">Tanggal</th>
                                </tr>
                            </thead>
                            <tbody id="attendanceTableBody">
                                <!-- Attendance data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="noDataMessage" class="text-center py-8 hidden">
                        <p class="text-gray-500 text-base sm:text-lg">Tidak ada data absensi yang ditemukan</p>
                        <p class="text-gray-400 text-sm mt-2">Silakan ubah filter atau tunggu data absensi masuk</p>
                    </div>
                </div>
            </div>
        </main>

        <footer class="bg-gray-800 text-white py-6 mt-16">
            <div class="container mx-auto px-4 text-center">
                <p>&copy; Hak Cipta SDIT Harapan Umat Karawang</p>
            </div>
        </footer>
    </div>

    <!-- Thank You Popup -->
    <div id="thankYouOverlay" class="thank-you-popup-overlay hidden"></div>
    <div id="thankYouPopup" class="thank-you-popup hidden">
        <div class="text-center">
            <div class="text-4xl mb-4">üôè</div>
            <h3 class="text-2xl font-bold mb-2">Terimakasih Ayah/Bunda</h3>
            <p class="text-lg opacity-90">Absensi telah berhasil disimpan</p>
        </div>
    </div>

    <script>
        let selectedTeacher = '';
        let selectedClass = '';
        let teachersData = [];
        let studentsData = [];
        let attendanceData = {};
        let savedAttendanceToday = {}; // Track saved attendance for today
        let isLoggedIn = false; // Track login status
        let allAttendanceRecords = []; // Store all attendance records

        // Load students data from Google Sheets CSV
        async function loadStudentsData() {
            try {
                const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vRo9cNtTtxitP8XPlHXbnT-458XW2xzsCUNAkFY-M9FmxzRJrSXKHeJfFYoTfLXfpSS0ICcKQYUkIEm/pub?output=csv');
                const csvText = await response.text();
                
                console.log('CSV Response:', csvText); // Debug log
                
                // Parse CSV data with better handling
                const lines = csvText.split('\n').filter(line => line.trim());
                if (lines.length === 0) throw new Error('No data in CSV');
                
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                console.log('Headers:', headers); // Debug log
                
                studentsData = [];
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim()) {
                        // Handle CSV with quotes and commas properly
                        const values = parseCSVLine(lines[i]);
                        const student = {};
                        headers.forEach((header, index) => {
                            student[header] = values[index] ? values[index].trim().replace(/"/g, '') : '';
                        });
                        studentsData.push(student);
                    }
                }
                
                console.log('Loaded students:', studentsData); // Debug log
                
            } catch (error) {
                console.error('Error loading students data:', error);
                // Enhanced fallback data matching CSV structure
                studentsData = [
                    { 'nama siswa': 'Kanaya Izzatunnisa', kelas: '1', 'nama guru': 'Bu Indi' },
                    { 'nama siswa': 'Muhamad Rafli Nurrachman', kelas: '1', 'nama guru': 'Bu Indi' },
                    { 'nama siswa': 'Muhammad Atharrazka', kelas: '1', 'nama guru': 'Bu Indi' },
                    { 'nama siswa': 'Ahmad Fauzi', kelas: '2', 'nama guru': 'Bu Sari' },
                    { 'nama siswa': 'Siti Aisyah', kelas: '2', 'nama guru': 'Bu Sari' },
                    { 'nama siswa': 'Budi Santoso', kelas: '3', 'nama guru': 'Pak Ahmad' },
                    { 'nama siswa': 'Muhammad Ali', kelas: '3', 'nama guru': 'Pak Ahmad' },
                    { 'nama siswa': 'Fatimah Zahra', kelas: '4', 'nama guru': 'Bu Fatimah' },
                    { 'nama siswa': 'Dewi Sari', kelas: '4', 'nama guru': 'Bu Fatimah' }
                ];
                console.log('Using fallback data:', studentsData);
            }
        }

        // Helper function to parse CSV line properly
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }

        // Get today's date as string for comparison
        function getTodayString() {
            return new Date().toDateString();
        }

        // Check if attendance was already saved today for a student
        function isAttendanceSavedToday(studentId) {
            const today = getTodayString();
            return savedAttendanceToday[studentId] === today;
        }

        // Mark attendance as saved for today
        function markAttendanceSavedToday(studentId) {
            const today = getTodayString();
            savedAttendanceToday[studentId] = today;
            // Save to localStorage for persistence
            localStorage.setItem('savedAttendanceToday', JSON.stringify(savedAttendanceToday));
        }

        // Load saved attendance data from localStorage
        function loadSavedAttendanceData() {
            const saved = localStorage.getItem('savedAttendanceToday');
            if (saved) {
                savedAttendanceToday = JSON.parse(saved);
                // Clean up old dates (keep only today's data)
                const today = getTodayString();
                Object.keys(savedAttendanceToday).forEach(key => {
                    if (savedAttendanceToday[key] !== today) {
                        delete savedAttendanceToday[key];
                    }
                });
                localStorage.setItem('savedAttendanceToday', JSON.stringify(savedAttendanceToday));
            }
        }

        // Show thank you popup with smooth animation
        function showThankYouPopup() {
            const overlay = document.getElementById('thankYouOverlay');
            const popup = document.getElementById('thankYouPopup');
            
            // Show elements
            overlay.classList.remove('hidden');
            popup.classList.remove('hidden');
            
            // Trigger animation after a small delay for smoother effect
            setTimeout(() => {
                overlay.classList.add('show');
                popup.classList.add('show');
            }, 50);
            
            // Auto hide after 3 seconds
            setTimeout(() => {
                hideThankYouPopup();
            }, 3500);
        }

        // Hide thank you popup with smooth animation
        function hideThankYouPopup() {
            const overlay = document.getElementById('thankYouOverlay');
            const popup = document.getElementById('thankYouPopup');
            
            // Remove show classes to trigger fade out
            overlay.classList.remove('show');
            popup.classList.remove('show');
            
            // Hide elements after animation completes (increased time for smoother transition)
            setTimeout(() => {
                overlay.classList.add('hidden');
                popup.classList.add('hidden');
            }, 600);
        }

        // Load teachers data from Google Sheets CSV
        async function loadTeachersData() {
            try {
                const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vTgKecXy9cdc6rsoGURVhUJDJB6hloM7RC4P2cvC3bFw7ezL73KJFSgNURKL33YBndg5pBm9fZST7Hb/pub?output=csv');
                const csvText = await response.text();
                
                console.log('Teachers CSV Response:', csvText); // Debug log
                
                // Parse CSV data with better handling
                const lines = csvText.split('\n').filter(line => line.trim());
                if (lines.length === 0) throw new Error('No data in CSV');
                
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                console.log('Teachers Headers:', headers); // Debug log
                
                teachersData = [];
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim()) {
                        // Handle CSV with quotes and commas properly
                        const values = parseCSVLine(lines[i]);
                        const teacherName = values[0]?.trim().replace(/"/g, '') || `Guru ${i}`;
                        const teacherPhoto = values[1]?.trim().replace(/"/g, '') || '';
                        
                        // Always use photo from Google Sheets, create placeholder if empty
                        const photoUrl = teacherPhoto || `https://via.placeholder.com/150x150/667eea/ffffff?text=${encodeURIComponent(teacherName)}`;
                        
                        teachersData.push({
                            name: teacherName,
                            photo: photoUrl
                        });
                        
                        console.log('Loaded teacher:', teacherName, 'Photo:', photoUrl); // Debug log
                    }
                }
                
                console.log('Final teachers data:', teachersData); // Debug log
                displayTeachers();
                
            } catch (error) {
                console.error('Error loading teachers data:', error);
                // Even in fallback, try to load from a basic structure
                teachersData = [
                    { name: 'Bu Indi', photo: 'https://via.placeholder.com/150x150/667eea/ffffff?text=Bu+Indi' },
                    { name: 'Bu Sari', photo: 'https://via.placeholder.com/150x150/764ba2/ffffff?text=Bu+Sari' },
                    { name: 'Pak Ahmad', photo: 'https://via.placeholder.com/150x150/667eea/ffffff?text=Pak+Ahmad' },
                    { name: 'Bu Fatimah', photo: 'https://via.placeholder.com/150x150/764ba2/ffffff?text=Bu+Fatimah' }
                ];
                displayTeachers();
            }
        }

        function displayTeachers() {
            const grid = document.getElementById('teachersGrid');
            grid.innerHTML = '';
            
            teachersData.forEach(teacher => {
                const teacherCard = document.createElement('div');
                teacherCard.className = 'teacher-card bg-white rounded-xl shadow-lg p-6 text-center cursor-pointer';
                teacherCard.onclick = () => selectTeacher(teacher.name);
                
                // Create image element with error handling
                const img = document.createElement('img');
                img.src = teacher.photo;
                img.alt = teacher.name;
                img.className = 'w-24 h-24 rounded-full mx-auto mb-4 object-cover border-2 border-gray-200';
                
                // Handle image load error - fallback to placeholder
                img.onerror = function() {
                    this.src = `https://via.placeholder.com/150x150/667eea/ffffff?text=${encodeURIComponent(teacher.name)}`;
                };
                
                const title = document.createElement('h3');
                title.className = 'text-lg font-semibold text-gray-800';
                title.textContent = teacher.name;
                
                teacherCard.appendChild(img);
                teacherCard.appendChild(title);
                grid.appendChild(teacherCard);
            });
        }

        function showLoginModal() {
            const modal = document.getElementById('loginModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => modal.classList.add('show'), 10);
        }

        function hideLoginModal() {
            const modal = document.getElementById('loginModal');
            modal.classList.remove('show');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }, 300);
        }

        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (username === 'admin' && password === 'gurutahta') {
                isLoggedIn = true;
                localStorage.setItem('isLoggedIn', 'true');
                
                // Update UI
                document.getElementById('loginButton').classList.add('hidden');
                document.getElementById('adminButton').classList.remove('hidden');
                
                hideLoginModal();
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                
                // Automatically redirect to admin page
                setTimeout(() => {
                    showAdminPage();
                }, 300);
            } else {
                alert('Username atau password salah!');
            }
        }

        function selectTeacher(teacherName) {
            selectedTeacher = teacherName;
            showClassModal();
        }

        function showClassModal() {
            const modal = document.getElementById('classModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => modal.classList.add('show'), 10);
        }

        function hideClassModal() {
            const modal = document.getElementById('classModal');
            modal.classList.remove('show');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }, 300);
        }

        function selectClass(classNumber) {
            selectedClass = classNumber;
            
            // Immediately hide modal and show attendance page
            const modal = document.getElementById('classModal');
            modal.classList.remove('show');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            
            // Show attendance page immediately
            showAttendancePage();
        }

        function displayStudents() {
    const container = document.getElementById('studentsContainer');
    container.innerHTML = '';

    const filteredStudents = studentsData.filter(student => {
        const studentClass = student.kelas || student.class || student.Kelas || student.Class ||
                             student['Kelas'] || student['kelas'] || student['class'] || student['Class'];
        const studentTeacher = student.guru || student.teacher || student.Guru || student.Teacher ||
                             student['Guru'] || student['guru'] || student['teacher'] || student['Teacher'] ||
                             student['nama guru'] || student['Nama Guru'] || student['NAMA GURU'] ||
                             student[''] || student[' '] || student['guru '] || student[' guru'];

        const classMatch = String(studentClass).trim().toLowerCase().startsWith(String(selectedClass).trim().toLowerCase());
        const teacherMatch = String(studentTeacher).trim() === String(selectedTeacher).trim();
        return classMatch && teacherMatch;
    });

    // Sort by nama siswa (A-Z)
    filteredStudents.sort((a, b) => {
        const nameA = (a['nama siswa'] || a.nama || a.name || a.Nama || a.Name || '').toLowerCase();
        const nameB = (b['nama siswa'] || b.nama || b.name || b.Nama || b.Name || '').toLowerCase();
        if (nameA < nameB) return -1;
        if (nameA > nameB) return 1;
        return 0;
    });

    if (filteredStudents.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8">
                <p class="text-gray-500 text-lg">Tidak ada data siswa untuk Kelas ${selectedClass} - ${selectedTeacher}</p>
                <p class="text-gray-400 text-sm mt-2">Total siswa di database: ${studentsData.length}</p>
                <p class="text-gray-400 text-sm">Silakan periksa kembali data atau hubungi administrator</p>
            </div>
        `;
        return;
    }

    filteredStudents.forEach((student, index) => {
        const studentName = student['nama siswa'] || student.nama || student.name || student.Nama || student.Name || `Siswa ${index + 1}`;
        const studentClass = student.kelas || student.class || student.Kelas || student.Class ||
                             student['Kelas'] || student['kelas'] || student['class'] || student['Class'];
        const studentId = `student_${studentName.replace(/\s+/g, '_')}_${studentClass}_${selectedTeacher.replace(/\s+/g, '_')}`;
        const isAlreadySaved = isAttendanceSavedToday(studentId);
        const disabledClass = isAlreadySaved ? 'opacity-50 pointer-events-none' : '';
        const savedMessage = isAlreadySaved ? '<p class="text-sm text-green-600 font-medium mt-2">‚úÖ Absensi hari ini sudah tersimpan</p>' : '';

        const studentCard = document.createElement('div');
        studentCard.className = `bg-gray-50 rounded-lg p-3 sm:p-4 border border-gray-200 ${disabledClass}`;
        studentCard.innerHTML = `
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-3 sm:space-y-0">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 sm:w-10 sm:h-10 bg-gradient-to-r from-purple-500 to-blue-500 rounded-full flex items-center justify-center text-white font-bold text-sm sm:text-base">
                        ${index + 1}
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-800 text-sm sm:text-base">${studentName}</h4>
                        <p class="text-xs sm:text-sm text-gray-500">${studentClass}</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 sm:flex sm:space-x-2 gap-2 sm:gap-0">
                    <button onclick="setAttendance('${studentId}', 'hadir')" 
                            class="attendance-btn px-2 sm:px-4 py-2 rounded-lg border-2 transition-all duration-200 hover:scale-105 text-xs sm:text-sm" 
                            data-student="${studentId}" data-status="hadir" ${isAlreadySaved ? 'disabled' : ''}>
                        üòä Hadir
                    </button>
                    <button onclick="setAttendance('${studentId}', 'sakit')" 
                            class="attendance-btn px-2 sm:px-4 py-2 rounded-lg border-2 transition-all duration-200 hover:scale-105 text-xs sm:text-sm" 
                            data-student="${studentId}" data-status="sakit" ${isAlreadySaved ? 'disabled' : ''}>
                        ü§í Sakit
                    </button>
                    <button onclick="setAttendance('${studentId}', 'izin')" 
                            class="attendance-btn px-2 sm:px-4 py-2 rounded-lg border-2 transition-all duration-200 hover:scale-105 text-xs sm:text-sm" 
                            data-student="${studentId}" data-status="izin" ${isAlreadySaved ? 'disabled' : ''}>
                        üôè Izin
                    </button>
                    <button onclick="setAttendance('${studentId}', 'alpha')" 
                            class="attendance-btn px-2 sm:px-4 py-2 rounded-lg border-2 transition-all duration-200 hover:scale-105 text-xs sm:text-sm" 
                            data-student="${studentId}" data-status="alpha" ${isAlreadySaved ? 'disabled' : ''}>
                        ‚ùå Alpha
                    </button>
                </div>
            </div>
            <div class="mt-3 flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3">
                <input type="text" 
                       placeholder="Catatan (Halaman yang dibaca ananda) *Wajib diisi kecuali Alpha" 
                       class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-purple-500"
                       onchange="setNote('${studentId}', this.value)" ${isAlreadySaved ? 'disabled' : ''}>
                <button onclick="saveIndividualAttendance('${studentId}')" 
                        class="px-3 sm:px-4 py-2 bg-green-600 text-white rounded-lg text-xs sm:text-sm font-semibold hover:bg-green-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed whitespace-nowrap"
                        id="saveBtn_${studentId}" ${isAlreadySaved ? 'disabled' : 'disabled'}>
                    ${isAlreadySaved ? '‚úÖ Tersimpan' : 'üíæ Simpan'}
                </button>
            </div>
            ${savedMessage}
        `;
        container.appendChild(studentCard);

        // Initialize attendance data
        attendanceData[studentId] = {
            name: studentName,
            status: null,
            note: ''
        };
    });

            
            // Style attendance buttons
            updateAttendanceButtonStyles();
        }

        function setAttendance(studentId, status) {
            attendanceData[studentId].status = status;
            updateAttendanceButtonStyles();
            
            // Enable save button when status is selected
            const saveBtn = document.getElementById(`saveBtn_${studentId}`);
            if (saveBtn) {
                saveBtn.disabled = false;
            }
        }

        function setNote(studentId, note) {
            attendanceData[studentId].note = note;
        }

        function updateAttendanceButtonStyles() {
            document.querySelectorAll('.attendance-btn').forEach(btn => {
                const studentId = btn.dataset.student;
                const status = btn.dataset.status;
                const currentStatus = attendanceData[studentId]?.status;
                
                // Reset styles
                btn.className = 'attendance-btn px-4 py-2 rounded-lg border-2 transition-all duration-200 hover:scale-105';
                
                if (currentStatus === status) {
                    // Active state
                    switch (status) {
                        case 'hadir':
                            btn.className += ' bg-green-500 text-white border-green-500 shadow-lg';
                            break;
                        case 'sakit':
                            btn.className += ' bg-yellow-500 text-white border-yellow-500 shadow-lg';
                            break;
                        case 'izin':
                            btn.className += ' bg-blue-500 text-white border-blue-500 shadow-lg';
                            break;
                        case 'alpha':
                            btn.className += ' bg-red-500 text-white border-red-500 shadow-lg';
                            break;
                    }
                } else {
                    // Inactive state
                    switch (status) {
                        case 'hadir':
                            btn.className += ' bg-white text-green-600 border-green-300 hover:bg-green-50';
                            break;
                        case 'sakit':
                            btn.className += ' bg-white text-yellow-600 border-yellow-300 hover:bg-yellow-50';
                            break;
                        case 'izin':
                            btn.className += ' bg-white text-blue-600 border-blue-300 hover:bg-blue-50';
                            break;
                        case 'alpha':
                            btn.className += ' bg-white text-red-600 border-red-300 hover:bg-red-50';
                            break;
                    }
                }
            });
        }

        function saveIndividualAttendance(studentId) {
            // Check if already saved today
            if (isAttendanceSavedToday(studentId)) {
                alert('Absensi untuk siswa ini sudah disimpan hari ini!\nAnda dapat mengisi absensi kembali besok.');
                return;
            }
            
            const data = attendanceData[studentId];
            const today = new Date().toLocaleDateString('id-ID');
            
            if (!data.status) {
                alert('Silakan pilih status kehadiran terlebih dahulu!');
                return;
            }
            
            // Notes are required for all statuses except 'alpha'
            if (data.status !== 'alpha' && (!data.note || data.note.trim() === '')) {
                alert('Catatan wajib diisi! Silakan isi halaman yang dibaca ananda.');
                return;
            }
            
            const emoji = data.status === 'hadir' ? 'üòä' : 
                         data.status === 'sakit' ? 'ü§í' : 
                         data.status === 'izin' ? 'üôè' : '‚ùå';
            
            let message = `Kehadiran berhasil disimpan!\n\n`;
            message += `${emoji} ${data.name}: ${data.status.toUpperCase()}\n`;
            message += `Kelas: ${selectedClass}\n`;
            message += `Guru: ${selectedTeacher}\n`;
            message += `Tanggal: ${today}\n`;
            
            if (data.note) {
                message += `Catatan: ${data.note}\n`;
            }
            
            message += `\n‚ö†Ô∏è Absensi hanya bisa dikirim sekali per hari.`;
            
            // Save attendance record
            const attendanceRecord = {
                id: Date.now() + Math.random(),
                studentName: data.name,
                class: selectedClass,
                teacher: selectedTeacher,
                status: data.status,
                note: data.note,
                date: today,
                timestamp: new Date().toISOString()
            };
            
            allAttendanceRecords.push(attendanceRecord);
            localStorage.setItem('allAttendanceRecords', JSON.stringify(allAttendanceRecords));
            
            // Automatically save to Google Sheets
            saveToGoogleSheets(attendanceRecord);
            
            // Show thank you popup instead of alert
            showThankYouPopup();
            
            // Mark as saved for today
            markAttendanceSavedToday(studentId);
            
            // Disable all controls for this student
            const studentCard = document.querySelector(`#saveBtn_${studentId}`).closest('.bg-gray-50');
            studentCard.classList.add('opacity-50', 'pointer-events-none');
            
            // Update save button
            const saveBtn = document.getElementById(`saveBtn_${studentId}`);
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '‚úÖ Tersimpan';
                saveBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                saveBtn.classList.add('bg-gray-500');
            }
            
            // Add saved message
            const savedMessage = document.createElement('p');
            savedMessage.className = 'text-sm text-green-600 font-medium mt-2';
            savedMessage.innerHTML = '‚úÖ Absensi hari ini sudah tersimpan';
            studentCard.appendChild(savedMessage);
            
            // Disable attendance buttons
            const attendanceBtns = studentCard.querySelectorAll('.attendance-btn');
            attendanceBtns.forEach(btn => btn.disabled = true);
            
            // Disable note input
            const noteInput = studentCard.querySelector('input[type="text"]');
            if (noteInput) noteInput.disabled = true;
        }

        function showAttendancePage() {
            const mainPage = document.getElementById('mainPage');
            const attendancePage = document.getElementById('attendancePage');
            
            // Start fade out animation for main page
            mainPage.classList.add('fade-out');
            
            setTimeout(() => {
                // Hide main page completely
                mainPage.classList.add('hidden');
                
                // Show attendance page with fade in animation
                attendancePage.classList.remove('hidden');
                attendancePage.classList.add('fade-in');
                
                // Set content
                document.getElementById('classInfo').textContent = `Kelas ${selectedClass} - ${selectedTeacher}`;
                
                // Set current date
                const today = new Date();
                const options = {
                    weekday: 'long',
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                };
                const formattedDate = today.toLocaleDateString('id-ID', options);
                document.getElementById('currentDate').textContent = formattedDate;
                
                // Display students
                displayStudents();
                
                // Complete fade in animation
                setTimeout(() => {
                    attendancePage.classList.remove('fade-in');
                    attendancePage.classList.add('show');
                }, 50);
            }, 500);
        }

        function goBack() {
            const mainPage = document.getElementById('mainPage');
            const attendancePage = document.getElementById('attendancePage');
            
            // Start fade out animation for attendance page
            attendancePage.classList.remove('show');
            attendancePage.classList.add('fade-out');
            
            setTimeout(() => {
                // Hide attendance page completely
                attendancePage.classList.add('hidden');
                attendancePage.classList.remove('fade-out');
                
                // Show main page with fade in animation
                mainPage.classList.remove('hidden');
                mainPage.classList.remove('fade-out');
                mainPage.classList.add('fade-in');
                
                // Complete fade in animation
                setTimeout(() => {
                    mainPage.classList.remove('fade-in');
                    mainPage.classList.add('show');
                }, 50);
                
                // Reset selections
                selectedTeacher = '';
                selectedClass = '';
                attendanceData = {};
            }, 500);
        }



        // Handle Enter key for login
        document.getElementById('loginForm').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                handleLogin(e);
            }
        });

        // Admin page functions
        function showAdminPage() {
            if (!isLoggedIn) {
                alert('Anda harus login terlebih dahulu untuk mengakses Dashboard Admin!');
                return;
            }
            
            const mainPage = document.getElementById('mainPage');
            const adminPage = document.getElementById('adminPage');
            
            // Start fade out animation for main page
            mainPage.classList.add('fade-out');
            
            setTimeout(() => {
                // Hide main page completely
                mainPage.classList.add('hidden');
                
                // Show admin page with fade in animation
                adminPage.classList.remove('hidden');
                adminPage.classList.add('fade-in');
                
                // Load admin data from Google Sheets
                loadAdminDataFromGoogleSheets();
                
                // Complete fade in animation
                setTimeout(() => {
                    adminPage.classList.remove('fade-in');
                    adminPage.classList.add('show');
                }, 50);
            }, 500);
        }
        
        function goBackToMain() {
            const mainPage = document.getElementById('mainPage');
            const adminPage = document.getElementById('adminPage');
            
            // Start fade out animation for admin page
            adminPage.classList.remove('show');
            adminPage.classList.add('fade-out');
            
            setTimeout(() => {
                // Hide admin page completely
                adminPage.classList.add('hidden');
                adminPage.classList.remove('fade-out');
                
                // Show main page with fade in animation
                mainPage.classList.remove('hidden');
                mainPage.classList.remove('fade-out');
                mainPage.classList.add('fade-in');
                
                // Complete fade in animation
                setTimeout(() => {
                    mainPage.classList.remove('fade-in');
                    mainPage.classList.add('show');
                }, 50);
            }, 500);
        }
        
        function logout() {
            if (confirm('Apakah Anda yakin ingin logout?')) {
                isLoggedIn = false;
                localStorage.removeItem('isLoggedIn');
                
                // Update UI
                document.getElementById('loginButton').classList.remove('hidden');
                document.getElementById('adminButton').classList.add('hidden');
                
                // Go back to main page
                goBackToMain();
                
                alert('Anda telah berhasil logout.');
            }
        }
        
        // Load admin data from Google Sheets (online)
        async function loadAdminDataFromGoogleSheets() {
            try {
                // Show loading indicator
                showLoadingIndicator();
                
                // STEP 1: Load attendance data from Google Sheets CSV (Rekap Absensi sheet)
                // Using the provided Google Sheets link for automatic data loading
                
                const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQY52eT36lLpftANVU2IKXdTKZ8RfGhJ9rmIG_OGp_nlnBb3hA1ryJmznw8NaS9mYWtXNK8X8wlX2Jd/pub?gid=0&single=true&output=csv';
                
                console.log('Loading from URL:', csvUrl);
                
                const response = await fetch(csvUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                console.log('Attendance CSV Response:', csvText.substring(0, 500) + '...'); // Debug log (first 500 chars)
                
                // Parse CSV data
                const lines = csvText.split('\n').filter(line => line.trim());
                if (lines.length > 1) {
                    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                    console.log('Attendance Headers:', headers); // Debug log
                    
                    allAttendanceRecords = [];
                    for (let i = 1; i < lines.length; i++) {
                        if (lines[i].trim()) {
                            const values = parseCSVLine(lines[i]);
                            
                            // Map CSV columns to our data structure
                            // Expected Google Sheets format: Tanggal, Guru, Nama Siswa, Kelas, Kehadiran, Catatan
                            const record = {
                                id: Date.now() + Math.random() + i,
                                date: values[0]?.trim().replace(/"/g, '') || '',
                                teacher: values[1]?.trim().replace(/"/g, '') || '',
                                studentName: values[2]?.trim().replace(/"/g, '') || '',
                                class: values[3]?.trim().replace(/"/g, '') || '',
                                status: values[4]?.trim().replace(/"/g, '').toLowerCase() || '',
                                note: values[5]?.trim().replace(/"/g, '') || '',
                                timestamp: new Date().toISOString()
                            };
                            
                            // Only add valid records
                            if (record.studentName && record.status) {
                                allAttendanceRecords.push(record);
                            }
                        }
                    }
                    
                    console.log('‚úÖ Loaded attendance records from Google Sheets:', allAttendanceRecords.length);
                    
                    // Also save to localStorage as backup
                    localStorage.setItem('allAttendanceRecords', JSON.stringify(allAttendanceRecords));
                    
                    // Hide offline indicator if it was showing
                    hideOfflineIndicator();
                    
                    // Show success message
                    showGoogleSheetsStatus('online_success');
                } else {
                    throw new Error('No attendance data found in Google Sheets - sheet might be empty');
                }
                
            } catch (error) {
                console.error('‚ùå Error loading data from Google Sheets:', error);
                
                // Show detailed error message for debugging
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack
                });
                
                // Fallback to localStorage data
                const savedRecords = localStorage.getItem('allAttendanceRecords');
                if (savedRecords) {
                    allAttendanceRecords = JSON.parse(savedRecords);
                    console.log('üì± Using offline data:', allAttendanceRecords.length, 'records');
                    showOfflineIndicator();
                } else {
                    allAttendanceRecords = [];
                    console.log('üì≠ No offline data available');
                }
                
                // Show error status
                showGoogleSheetsStatus('error');
            }
            
            // Populate teacher filter
            const teacherFilter = document.getElementById('filterTeacher');
            teacherFilter.innerHTML = '<option value="">Semua Guru</option>';
            const uniqueTeachers = [...new Set(teachersData.map(t => t.name))];
            uniqueTeachers.forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher;
                option.textContent = teacher;
                teacherFilter.appendChild(option);
            });
            
            // Set current month as default
            const today = new Date();
            const currentMonth = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');
            document.getElementById('filterMonth').value = currentMonth;
            
            // Load and display data
            filterAttendanceData();
            
            // Hide loading indicator
            hideLoadingIndicator();
        }
        
        function loadAdminData() {
            // Fallback function for offline mode
            loadAdminDataFromGoogleSheets();
        }
        
        function filterAttendanceData() {
            const teacherFilter = document.getElementById('filterTeacher').value;
            const classFilter = document.getElementById('filterClass').value;
            const monthFilter = document.getElementById('filterMonth').value;
            
            let filteredRecords = allAttendanceRecords;
            
            // Apply filters
            if (teacherFilter) {
                filteredRecords = filteredRecords.filter(record => record.teacher === teacherFilter);
            }
            
            if (classFilter) {
                filteredRecords = filteredRecords.filter(record => record.class === classFilter);
            }
            
            if (monthFilter) {
                const [filterYear, filterMonth] = monthFilter.split('-');
                filteredRecords = filteredRecords.filter(record => {
                    const recordDate = new Date(record.timestamp);
                    const recordYear = recordDate.getFullYear();
                    const recordMonth = recordDate.getMonth() + 1;
                    
                    return recordYear == filterYear && recordMonth == filterMonth;
                });
            }
            
            // Show/hide monthly grid table based on filters
            const monthlyGridTable = document.getElementById('monthlyGridTable');
            if (teacherFilter && classFilter && monthFilter) {
                monthlyGridTable.classList.remove('hidden');
                generateMonthlyGrid(filteredRecords, teacherFilter, classFilter, monthFilter);
            } else {
                monthlyGridTable.classList.add('hidden');
            }
            
            // Update statistics
            updateStatistics(filteredRecords);
            
            // Update table
            updateAttendanceTable(filteredRecords);
            
            // Auto-sync filtered data to Google Sheets
            autoSyncAdminData();
        }
        
        function generateMonthlyGrid(records, teacher, classNum, monthFilter) {
    const monthlyTable = document.getElementById('monthlyAttendanceTable');
    const monthlyTableInfo = document.getElementById('monthlyTableInfo');
    
    // Update table info
    monthlyTableInfo.textContent = `${teacher} - Kelas ${classNum}`;
    
    // Get students for this teacher and class
    const studentsForClass = studentsData.filter(student => {
        const studentClass = student.kelas || student.class || student.Kelas || student.Class || 
                           student['Kelas'] || student['kelas'] || student['class'] || student['Class'];
        const studentTeacher = student.guru || student.teacher || student.Guru || student.Teacher || 
                             student['Guru'] || student['guru'] || student['teacher'] || student['Teacher'] ||
                             student['nama guru'] || student['Nama Guru'] || student['NAMA GURU'] ||
                             student[''] || student[' '] || student['guru '] || student[' guru'];
        const classMatch = String(studentClass).trim() === String(classNum).trim();
        const teacherMatch = String(studentTeacher).trim() === String(teacher).trim();
        return classMatch && teacherMatch;
    });
    
    if (studentsForClass.length === 0) {
        monthlyTable.innerHTML = '<tr><td class="text-center py-8 text-gray-500">Tidak ada data siswa untuk kelas ini</td></tr>';
        return;
    }
    
    // Get days in the selected month
    const [year, month] = monthFilter.split('-');
    const daysInMonth = new Date(year, month, 0).getDate();
    const monthDates = [];
    for (let day = 1; day <= daysInMonth; day++) {
        monthDates.push(day);
    }
    
    // Create table header
    let headerHTML = '<thead><tr class="bg-gray-50">';
    headerHTML += '<th class="px-2 py-3 text-left text-xs font-semibold text-gray-700 sticky left-0 bg-gray-50 min-w-[120px]">Nama Siswa</th>';
    monthDates.forEach(date => {
        headerHTML += `<th class="px-1 py-3 text-center text-xs font-semibold text-gray-700 min-w-[30px]">${date}</th>`;
    });
    // Kolom total rekap per bulan
    headerHTML += `<th class="px-2 py-3 text-center text-xs font-semibold text-gray-700 min-w-[50px]">Hadir</th>`;
    headerHTML += `<th class="px-2 py-3 text-center text-xs font-semibold text-gray-700 min-w-[50px]">Sakit</th>`;
    headerHTML += `<th class="px-2 py-3 text-center text-xs font-semibold text-gray-700 min-w-[50px]">Izin</th>`;
    headerHTML += `<th class="px-2 py-3 text-center text-xs font-semibold text-gray-700 min-w-[50px]">Alpha</th>`;
    headerHTML += `<th class="px-2 py-3 text-center text-xs font-semibold text-gray-700 min-w-[70px]">% Hadir</th>`;
    headerHTML += '</tr></thead>';
    
    // Create table body
    let bodyHTML = '<tbody>';
    studentsForClass.forEach((student, index) => {
        const studentName = student['nama siswa'] || student.nama || student.name || student.Nama || student.Name || `Siswa ${index + 1}`;
        let totalHadir = 0, totalSakit = 0, totalIzin = 0, totalAlpha = 0;
        bodyHTML += '<tr class="border-b border-gray-200 hover:bg-gray-50">';
        bodyHTML += `<td class="px-2 py-2 text-xs font-medium text-gray-900 sticky left-0 bg-white border-r border-gray-200">${studentName}</td>`;
        
        monthDates.forEach(date => {
            // Format tanggal yang mungkin digunakan
            const paddedDate = String(date).padStart(2, '0');
            const paddedMonth = String(month).padStart(2, '0');
            const dateFormats = [
                `${paddedDate}/${paddedMonth}/${year}`,
                `${date}/${month}/${year}`,
                `${paddedDate}/${month}/${year}`,
                `${date}/${paddedMonth}/${year}`,
                `${paddedDate}-${paddedMonth}-${year}`,
                `${date}-${month}-${year}`,
                `${year}-${paddedMonth}-${paddedDate}`,
                `${paddedMonth}/${paddedDate}/${year}`,
                `${month}/${date}/${year}`
            ];
            
            let attendanceRecord = null;
            for (const dateFormat of dateFormats) {
                attendanceRecord = records.find(record => 
                    record.studentName === studentName && record.date === dateFormat
                );
                if (attendanceRecord) break;
            }
            if (!attendanceRecord) {
                attendanceRecord = records.find(record => {
                    if (record.studentName !== studentName) return false;
                    let recordDate;
                    try {
                        if (record.date.includes('/')) {
                            const parts = record.date.split('/');
                            if (parts.length === 3) {
                                recordDate = new Date(parts[2], parts[1] - 1, parts[0]);
                            }
                        } else if (record.date.includes('-')) {
                            recordDate = new Date(record.date);
                        } else {
                            recordDate = new Date(record.date);
                        }
                        if (recordDate && !isNaN(recordDate)) {
                            const recordDay = recordDate.getDate();
                            const recordMonth = recordDate.getMonth() + 1;
                            const recordYear = recordDate.getFullYear();
                            return recordDay === date && recordMonth === parseInt(month) && recordYear === parseInt(year);
                        }
                    } catch (e) {}
                    return false;
                });
            }
            
            let statusSymbol = '';
            let cellClass = 'px-1 py-2 text-center text-xs font-semibold';
            if (attendanceRecord) {
                switch (attendanceRecord.status.toLowerCase()) {
                    case 'hadir':
                        statusSymbol = 'H';
                        cellClass += ' text-green-600 bg-green-50';
                        totalHadir++;
                        break;
                    case 'sakit':
                        statusSymbol = 'S';
                        cellClass += ' text-yellow-600 bg-yellow-50';
                        totalSakit++;
                        break;
                    case 'izin':
                        statusSymbol = 'I';
                        cellClass += ' text-blue-600 bg-blue-50';
                        totalIzin++;
                        break;
                    case 'alpha':
                    case '-':
                        statusSymbol = '-';
                        cellClass += ' text-red-600 bg-red-50';
                        totalAlpha++;
                        break;
                    default:
                        statusSymbol = '';
                        cellClass += ' text-gray-400 bg-gray-50';
                        totalAlpha++;
                }
            } else {
                // Tidak ada data, dianggap alpha
                statusSymbol = '';
                cellClass += ' text-gray-300 bg-gray-50';
                totalAlpha++;
            }
            bodyHTML += `<td class="${cellClass}">${statusSymbol}</td>`;
        });
        
        let totalHari = daysInMonth;
        let persentaseHadir = ((totalHadir / totalHari) * 100).toFixed(0);
        bodyHTML += `<td class="px-2 py-2 text-center text-xs font-semibold text-green-600">${totalHadir}</td>`;
        bodyHTML += `<td class="px-2 py-2 text-center text-xs font-semibold text-yellow-600">${totalSakit}</td>`;
        bodyHTML += `<td class="px-2 py-2 text-center text-xs font-semibold text-blue-600">${totalIzin}</td>`;
        bodyHTML += `<td class="px-2 py-2 text-center text-xs font-semibold text-red-600">${totalAlpha}</td>`;
        bodyHTML += `<td class="px-2 py-2 text-center text-xs font-semibold text-purple-600">${persentaseHadir}%</td>`;
        bodyHTML += '</tr>';
    });
    bodyHTML += '</tbody>';
            
            // Set the complete table HTML
            monthlyTable.innerHTML = headerHTML + bodyHTML;
            
            console.log('Monthly grid generated successfully');
        }
        
        function updateStatistics(records) {
            const stats = {
                hadir: records.filter(r => r.status === 'hadir').length,
                sakit: records.filter(r => r.status === 'sakit').length,
                izin: records.filter(r => r.status === 'izin').length,
                alpha: records.filter(r => r.status === 'alpha').length,
                absent: records.filter(r => r.status === '-').length
            };
            
            document.getElementById('totalHadir').textContent = stats.hadir;
            document.getElementById('totalSakit').textContent = stats.sakit;
            document.getElementById('totalIzin').textContent = stats.izin;
            document.getElementById('totalAlpha').textContent = stats.alpha + stats.absent;
        }
        
        function updateAttendanceTable(records) {
            const tableBody = document.getElementById('attendanceTableBody');
            const noDataMessage = document.getElementById('noDataMessage');
            
            if (records.length === 0) {
                tableBody.innerHTML = '';
                noDataMessage.classList.remove('hidden');
                return;
            }
            
            noDataMessage.classList.add('hidden');
            
            tableBody.innerHTML = records.map((record, index) => {
                const statusEmoji = record.status === 'hadir' ? 'üòä' : 
                                  record.status === 'sakit' ? 'ü§í' : 
                                  record.status === 'izin' ? 'üôè' : 
                                  record.status === '-' ? '‚ûñ' : '‚ùå';
                
                const statusColor = record.status === 'hadir' ? 'text-green-600' : 
                                  record.status === 'sakit' ? 'text-yellow-600' : 
                                  record.status === 'izin' ? 'text-blue-600' : 
                                  record.status === '-' ? 'text-gray-600' : 'text-red-600';
                
                return `
                    <tr class="border-b border-gray-200 hover:bg-gray-50">
                        <td class="px-2 sm:px-4 py-3 text-xs sm:text-sm text-gray-700">${index + 1}</td>
                        <td class="px-2 sm:px-4 py-3 text-xs sm:text-sm font-medium text-gray-900">
                            <div class="sm:hidden text-xs text-gray-500 mb-1">Kelas ${record.class} ‚Ä¢ ${record.teacher}</div>
                            ${record.studentName}
                        </td>
                        <td class="px-2 sm:px-4 py-3 text-xs sm:text-sm text-gray-700 hidden sm:table-cell">Kelas ${record.class}</td>
                        <td class="px-2 sm:px-4 py-3 text-xs sm:text-sm text-gray-700 hidden md:table-cell">${record.teacher}</td>
                        <td class="px-2 sm:px-4 py-3 text-xs sm:text-sm ${statusColor} font-medium">
                            <div class="sm:hidden">${statusEmoji}</div>
                            <div class="hidden sm:block">${statusEmoji} ${record.status === '-' ? 'TIDAK HADIR' : record.status.toUpperCase()}</div>
                        </td>
                        <td class="px-2 sm:px-4 py-3 text-xs sm:text-sm text-gray-700 hidden lg:table-cell max-w-xs truncate" title="${record.note}">${record.note}</td>
                        <td class="px-2 sm:px-4 py-3 text-xs sm:text-sm text-gray-700 hidden sm:table-cell">${record.date}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function checkLoginStatus() {
            const savedLoginStatus = localStorage.getItem('isLoggedIn');
            if (savedLoginStatus === 'true') {
                isLoggedIn = true;
                document.getElementById('loginButton').classList.add('hidden');
                document.getElementById('adminButton').classList.remove('hidden');
            }
        }

        // Google Sheets Integration Functions
        async function saveToGoogleSheets(attendanceRecord) {
            try {
                // Configuration - URL Google Apps Script untuk rekap absensi otomatis
                const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwIfruSjIM_EvdnLqbPg-ghFJNmojuV36CiGgEcYYoIk-9vqBdBpu_ejBZqi-ZmXuts/exec';
                
                // Prepare data for Google Sheets with new format: Tanggal, Guru, Nama Siswa, Kelas, Kehadiran, Catatan
                const sheetData = {
                    action: 'addAttendance',
                    data: {
                        tanggal: attendanceRecord.date,
                        guru: attendanceRecord.teacher,
                        namaSiswa: attendanceRecord.studentName,
                        kelas: attendanceRecord.class,
                        kehadiran: attendanceRecord.status.toUpperCase(),
                        catatan: attendanceRecord.note || '-'
                    }
                };
                
                // Send data using fetch with CORS bypass
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // This bypasses CORS
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(sheetData)
                });
                
                console.log('Data berhasil dikirim ke Google Sheets');
                
                // Show success indicator (optional)
                showGoogleSheetsStatus('success');
                
            } catch (error) {
                console.error('Error mengirim data ke Google Sheets:', error);
                showGoogleSheetsStatus('error');
                
                // Data tetap tersimpan lokal meskipun gagal ke Google Sheets
            }
        }

        // Auto-sync admin dashboard data to Google Sheets
        async function autoSyncAdminData() {
            if (!isLoggedIn) return;
            
            try {
                const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwIfruSjIM_EvdnLqbPg-ghFJNmojuV36CiGgEcYYoIk-9vqBdBpu_ejBZqi-ZmXuts/exec';
                
                // Get current filter values
                const teacherFilter = document.getElementById('filterTeacher').value;
                const classFilter = document.getElementById('filterClass').value;
                const monthFilter = document.getElementById('filterMonth').value;
                
                // Prepare filtered data for sync
                let filteredRecords = allAttendanceRecords;
                
                if (teacherFilter) {
                    filteredRecords = filteredRecords.filter(record => record.teacher === teacherFilter);
                }
                
                if (classFilter) {
                    filteredRecords = filteredRecords.filter(record => record.class === classFilter);
                }
                
                if (monthFilter) {
                    const [filterYear, filterMonth] = monthFilter.split('-');
                    filteredRecords = filteredRecords.filter(record => {
                        const recordDate = new Date(record.timestamp);
                        const recordYear = recordDate.getFullYear();
                        const recordMonth = recordDate.getMonth() + 1;
                        
                        return recordYear == filterYear && recordMonth == filterMonth;
                    });
                }
                
                // Send summary data to Google Sheets
                const summaryData = {
                    action: 'updateSummary',
                    data: {
                        filter: {
                            guru: teacherFilter || 'Semua Guru',
                            kelas: classFilter || 'Semua Kelas',
                            bulan: monthFilter || 'Semua Bulan'
                        },
                        statistics: {
                            totalHadir: filteredRecords.filter(r => r.status === 'hadir').length,
                            totalSakit: filteredRecords.filter(r => r.status === 'sakit').length,
                            totalIzin: filteredRecords.filter(r => r.status === 'izin').length,
                            totalAlpha: filteredRecords.filter(r => r.status === 'alpha').length,
                            totalData: filteredRecords.length
                        },
                        lastUpdate: new Date().toLocaleString('id-ID')
                    }
                };
                
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(summaryData)
                });
                
                console.log('Admin dashboard data synced to Google Sheets');
                
            } catch (error) {
                console.error('Error syncing admin data:', error);
            }
        }
        
        // Show loading indicator
        function showLoadingIndicator() {
            const indicator = document.getElementById('loadingIndicator');
            const statusIndicator = document.getElementById('dataStatusIndicator');
            if (indicator) {
                indicator.classList.remove('hidden');
            }
            if (statusIndicator) {
                statusIndicator.classList.add('hidden');
            }
        }
        
        // Hide loading indicator
        function hideLoadingIndicator() {
            const indicator = document.getElementById('loadingIndicator');
            if (indicator) {
                indicator.classList.add('hidden');
            }
        }
        
        // Show offline indicator
        function showOfflineIndicator() {
            const indicator = document.getElementById('dataStatusIndicator');
            if (indicator) {
                indicator.classList.remove('hidden');
            }
        }
        
        // Hide offline indicator
        function hideOfflineIndicator() {
            const indicator = document.getElementById('dataStatusIndicator');
            if (indicator) {
                indicator.classList.add('hidden');
            }
        }
        
        // Refresh data from Google Sheets
        async function refreshDataFromGoogleSheets() {
            if (!isLoggedIn) {
                alert('Anda harus login sebagai admin untuk refresh data!');
                return;
            }
            
            await loadAdminDataFromGoogleSheets();
        }

        // Show Google Sheets sync status
        function showGoogleSheetsStatus(status) {
            const statusDiv = document.createElement('div');
            statusDiv.className = `fixed top-4 right-4 px-4 py-2 rounded-lg text-white text-sm font-medium z-50 transition-all duration-300`;
            
            if (status === 'success') {
                statusDiv.className += ' bg-green-500';
                statusDiv.innerHTML = '‚úÖ Data tersinkron ke Google Sheets';
            } else if (status === 'online_success') {
                statusDiv.className += ' bg-blue-500';
                statusDiv.innerHTML = 'üìä Data berhasil dimuat dari Google Sheets';
            } else if (status === 'download_success') {
                statusDiv.className += ' bg-green-500';
                statusDiv.innerHTML = 'üìä File Excel berhasil didownload';
            } else {
                statusDiv.className += ' bg-orange-500';
                statusDiv.innerHTML = '‚ö†Ô∏è Tersimpan lokal (Google Sheets offline)';
            }
            
            document.body.appendChild(statusDiv);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                statusDiv.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(statusDiv);
                }, 300);
            }, 3000);
        }
        
        // Bulk sync function for admin (sync all local data to Google Sheets)
        async function syncAllToGoogleSheets() {
            if (!isLoggedIn) {
                alert('Anda harus login sebagai admin untuk melakukan sinkronisasi!');
                return;
            }
            
            if (allAttendanceRecords.length === 0) {
                alert('Tidak ada data lokal untuk disinkronkan.');
                return;
            }
            
            if (!confirm(`Sinkronkan ${allAttendanceRecords.length} data absensi ke Google Sheets?`)) {
                return;
            }
            
            const syncButton = document.getElementById('syncButton');
            if (syncButton) {
                syncButton.disabled = true;
                syncButton.innerHTML = 'üîÑ Menyinkronkan...';
            }
            
            let successCount = 0;
            let errorCount = 0;
            
            for (let i = 0; i < allAttendanceRecords.length; i++) {
                try {
                    await saveToGoogleSheets(allAttendanceRecords[i]);
                    successCount++;
                    
                    // Small delay to avoid overwhelming the server
                    await new Promise(resolve => setTimeout(resolve, 100));
                } catch (error) {
                    errorCount++;
                    console.error('Error syncing record:', allAttendanceRecords[i], error);
                }
            }
            
            if (syncButton) {
                syncButton.disabled = false;
                syncButton.innerHTML = 'üìä Sinkron ke Google Sheets';
            }
            
            alert(`Sinkronisasi selesai!\n‚úÖ Berhasil: ${successCount}\n‚ùå Gagal: ${errorCount}`);
        }

        // Auto-send absent data for students who didn't fill attendance
        function sendAbsentDataForMissingStudents() {
            if (!selectedTeacher || !selectedClass) return;
            
            const today = new Date().toLocaleDateString('id-ID');
            const todayString = new Date().toDateString();
            
            // Get students for current class and teacher
            const filteredStudents = studentsData.filter(student => {
                const studentClass = student.kelas || student.class || student.Kelas || student.Class || 
                                   student['Kelas'] || student['kelas'] || student['class'] || student['Class'];
                const studentTeacher = student.guru || student.teacher || student.Guru || student.Teacher || 
                                     student['Guru'] || student['guru'] || student['teacher'] || student['Teacher'] ||
                                     student['nama guru'] || student['Nama Guru'] || student['NAMA GURU'] ||
                                     student[''] || student[' '] || student['guru '] || student[' guru'];
                
                const classMatch = String(studentClass).trim() === String(selectedClass).trim();
                const teacherMatch = String(studentTeacher).trim() === String(selectedTeacher).trim();
                
                return classMatch && teacherMatch;
            });
            
            // Check each student and send '-' for those who didn't fill attendance
            filteredStudents.forEach((student, index) => {
                const studentId = `student_${index}`;
                const studentName = student['nama siswa'] || student.nama || student.name || student.Nama || student.Name || `Siswa ${index + 1}`;
                
                // Check if this student already filled attendance today
                if (!isAttendanceSavedToday(studentId)) {
                    // Send '-' data to Google Sheets for absent students
                    const absentRecord = {
                        id: Date.now() + Math.random(),
                        studentName: studentName,
                        class: selectedClass,
                        teacher: selectedTeacher,
                        status: '-',
                        note: '-',
                        date: today,
                        timestamp: new Date().toISOString()
                    };
                    
                    // Save to Google Sheets
                    saveToGoogleSheets(absentRecord);
                    
                    // Also save to local records for admin tracking
                    allAttendanceRecords.push(absentRecord);
                    localStorage.setItem('allAttendanceRecords', JSON.stringify(allAttendanceRecords));
                    
                    console.log(`Sent absent data (-) for student: ${studentName}`);
                }
            });
        }
        
        // Auto-check for missing attendance at end of day (23:59)
        function scheduleAbsentDataCheck() {
            const now = new Date();
            const endOfDay = new Date();
            endOfDay.setHours(23, 59, 0, 0);
            
            const timeUntilEndOfDay = endOfDay.getTime() - now.getTime();
            
            if (timeUntilEndOfDay > 0) {
                setTimeout(() => {
                    sendAbsentDataForMissingStudents();
                    // Schedule for next day
                    setTimeout(scheduleAbsentDataCheck, 24 * 60 * 60 * 1000);
                }, timeUntilEndOfDay);
            } else {
                // If it's already past 23:59, schedule for next day
                setTimeout(scheduleAbsentDataCheck, 24 * 60 * 60 * 1000);
            }
        }
        
        // Download monthly attendance table as Excel
        function downloadMonthlyExcel() {
            const teacherFilter = document.getElementById('filterTeacher').value;
            const classFilter = document.getElementById('filterClass').value;
            const monthFilter = document.getElementById('filterMonth').value;
            
            if (!teacherFilter || !classFilter || !monthFilter) {
                alert('Silakan pilih Guru, Kelas, dan Bulan terlebih dahulu untuk mendownload rekap bulanan!');
                return;
            }
            
            const table = document.getElementById('monthlyAttendanceTable');
            if (!table || table.innerHTML.trim() === '') {
                alert('Tabel rekap bulanan tidak ditemukan atau kosong!');
                return;
            }
            
            try {
                // Create CSV content with BOM for proper Excel encoding
                let csvContent = '\uFEFF'; // BOM for UTF-8
                
                // Add header information
                const [year, month] = monthFilter.split('-');
                const monthNames = ['', 'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                                  'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
                
                csvContent += `REKAP ABSENSI BULANAN GEMAR MENGAJI;;\r\n`;
                csvContent += `SDIT Harapan Umat Karawang;;\r\n`;
                csvContent += `Guru: ${teacherFilter};;\r\n`;
                csvContent += `Kelas: ${classFilter};;\r\n`;
                csvContent += `Bulan: ${monthNames[parseInt(month)]} ${year};;\r\n`;
                csvContent += `Tanggal Cetak: ${new Date().toLocaleDateString('id-ID')};;\r\n`;
                csvContent += `;;\r\n`;
                csvContent += `Keterangan: H=Hadir; S=Sakit; I=Izin; -=Alpha;;\r\n`;
                csvContent += `;;\r\n`;
                
                // Get table data
                const rows = table.querySelectorAll('tr');
                if (rows.length === 0) {
                    alert('Tidak ada data dalam tabel untuk didownload!');
                    return;
                }
                
                rows.forEach(row => {
                    const cells = row.querySelectorAll('th, td');
                    const rowData = Array.from(cells).map(cell => {
                        let text = cell.textContent.trim();
                        // Handle special characters for CSV
                        if (text.includes(';') || text.includes('"') || text.includes('\n') || text.includes('\r')) {
                            text = text.replace(/"/g, '""');
                            text = `"${text}"`;
                        }
                        return text;
                    });
                    csvContent += rowData.join(';') + '\r\n';
                });
                
                // Create filename
                const filename = `Rekap_Absensi_${teacherFilter.replace(/[^a-zA-Z0-9]/g, '_')}_Kelas${classFilter}_${monthNames[parseInt(month)]}_${year}.csv`;
                
                console.log('Creating download with filename:', filename);
                console.log('CSV content length:', csvContent.length);
                
                // Create blob with proper MIME type
                const blob = new Blob([csvContent], { 
                    type: 'text/csv;charset=utf-8;' 
                });
                
                console.log('Blob created, size:', blob.size);
                
                // Multiple download methods with better error handling
                let downloadSuccess = false;
                
                // Method 1: IE/Edge specific
                if (window.navigator && window.navigator.msSaveOrOpenBlob) {
                    console.log('Using IE/Edge download method');
                    window.navigator.msSaveOrOpenBlob(blob, filename);
                    downloadSuccess = true;
                } else {
                    // Method 2: Modern browsers
                    console.log('Using modern browser download method');
                    
                    const url = window.URL.createObjectURL(blob);
                    console.log('Object URL created:', url);
                    
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    link.style.display = 'none';
                    
                    // Add to DOM
                    document.body.appendChild(link);
                    console.log('Link added to DOM');
                    
                    // Trigger download
                    link.click();
                    console.log('Download triggered');
                    
                    // Cleanup after short delay
                    setTimeout(() => {
                        try {
                            document.body.removeChild(link);
                            window.URL.revokeObjectURL(url);
                            console.log('Cleanup completed');
                        } catch (cleanupError) {
                            console.log('Cleanup error (non-critical):', cleanupError);
                        }
                    }, 1000);
                    
                    downloadSuccess = true;
                }
                
                if (downloadSuccess) {
                    // Show success notification
                    const notification = document.createElement('div');
                    notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                    notification.innerHTML = '‚úÖ File Excel berhasil didownload!';
                    document.body.appendChild(notification);
                    
                    setTimeout(() => {
                        if (document.body.contains(notification)) {
                            document.body.removeChild(notification);
                        }
                    }, 3000);
                    
                    console.log('Download completed successfully');
                } else {
                    throw new Error('All download methods failed');
                }
                
            } catch (error) {
                console.error('Download error:', error);
                
                // Fallback: Show data in new window for manual copy
                try {
                    const newWindow = window.open('', '_blank', 'width=800,height=600');
                    if (newWindow) {
                        newWindow.document.write(`
                            <!DOCTYPE html>
                            <html>
                            <head>
                                <title>Rekap Absensi - Copy Manual</title>
                                <style>
                                    body { font-family: Arial, sans-serif; padding: 20px; }
                                    textarea { width: 100%; height: 400px; font-family: monospace; font-size: 12px; }
                                    button { padding: 10px 20px; margin: 10px 5px; font-size: 14px; }
                                    .info { background: #f0f8ff; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
                                </style>
                            </head>
                            <body>
                                <div class="info">
                                    <h3>üìä Data Rekap Absensi</h3>
                                    <p><strong>Guru:</strong> ${teacherFilter}</p>
                                    <p><strong>Kelas:</strong> ${classFilter}</p>
                                    <p><strong>Bulan:</strong> ${monthFilter}</p>
                                    <p>Silakan copy semua data di bawah ini dan paste ke Excel/Google Sheets:</p>
                                </div>
                                <textarea id="csvData" readonly>${csvContent}</textarea>
                                <br>
                                <button onclick="document.getElementById('csvData').select(); document.execCommand('copy'); alert('Data berhasil dicopy ke clipboard!');">üìã Copy ke Clipboard</button>
                                <button onclick="window.close()">‚ùå Tutup</button>
                            </body>
                            </html>
                        `);
                        newWindow.document.close();
                        
                        // Show fallback notification
                        const notification = document.createElement('div');
                        notification.className = 'fixed top-4 right-4 bg-orange-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                        notification.innerHTML = '‚ö†Ô∏è Download otomatis gagal. Jendela baru terbuka untuk copy manual.';
                        document.body.appendChild(notification);
                        
                        setTimeout(() => {
                            if (document.body.contains(notification)) {
                                document.body.removeChild(notification);
                            }
                        }, 5000);
                    } else {
                        throw new Error('Cannot open fallback window');
                    }
                } catch (fallbackError) {
                    console.error('Fallback error:', fallbackError);
                    alert('Download gagal dan fallback tidak dapat dibuka. Silakan coba lagi atau hubungi administrator.');
                }
            }
        }
        
        // Print monthly attendance table
        function printMonthlyTable() {
            const teacherFilter = document.getElementById('filterTeacher').value;
            const classFilter = document.getElementById('filterClass').value;
            const monthFilter = document.getElementById('filterMonth').value;
            
            if (!teacherFilter || !classFilter || !monthFilter) {
                alert('Silakan pilih Guru, Kelas, dan Bulan terlebih dahulu untuk mencetak rekap bulanan!');
                return;
            }
            
            const table = document.getElementById('monthlyAttendanceTable');
            if (!table) {
                alert('Tabel rekap bulanan tidak ditemukan!');
                return;
            }
            
            // Create print window
            const printWindow = window.open('', '_blank');
            
            const [year, month] = monthFilter.split('-');
            const monthNames = ['', 'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                              'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            
            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Rekap Absensi Bulanan - ${teacherFilter} Kelas ${classFilter}</title>
                    <style>
                        @page {
                            size: A4 landscape;
                            margin: 1cm;
                        }
                        body {
                            font-family: Arial, sans-serif;
                            font-size: 12px;
                            margin: 0;
                            padding: 20px;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 20px;
                            border-bottom: 2px solid #333;
                            padding-bottom: 15px;
                        }
                        .header h1 {
                            margin: 0;
                            font-size: 18px;
                            font-weight: bold;
                        }
                        .header h2 {
                            margin: 5px 0;
                            font-size: 16px;
                            font-weight: normal;
                        }
                        .info {
                            margin-bottom: 15px;
                        }
                        .info div {
                            margin: 3px 0;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 20px;
                        }
                        th, td {
                            border: 1px solid #333;
                            padding: 4px 6px;
                            text-align: center;
                            font-size: 10px;
                        }
                        th {
                            background-color: #f0f0f0;
                            font-weight: bold;
                        }
                        th:first-child, td:first-child {
                            text-align: left;
                            min-width: 120px;
                        }
                        .legend {
                            margin-top: 15px;
                            font-size: 11px;
                        }
                        .footer {
                            margin-top: 30px;
                            display: flex;
                            justify-content: space-between;
                        }
                        .signature {
                            text-align: center;
                            width: 200px;
                        }
                        .signature-line {
                            border-top: 1px solid #333;
                            margin-top: 60px;
                            padding-top: 5px;
                        }
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>REKAP ABSENSI BULANAN GEMAR MENGAJI</h1>
                        <h2>SDIT Harapan Umat Karawang</h2>
                        <p>Jl. Pakuncen No. 01, Desa Sukaharja, Kec. Teluk Jambe Timur</p>
                    </div>
                    
                    <div class="info">
                        <div><strong>Guru:</strong> ${teacherFilter}</div>
                        <div><strong>Kelas:</strong> ${classFilter}</div>
                        <div><strong>Bulan:</strong> ${monthNames[parseInt(month)]} ${year}</div>
                        <div><strong>Tanggal Cetak:</strong> ${new Date().toLocaleDateString('id-ID')}</div>
                    </div>
                    
                    ${table.outerHTML}
                    
                    <div class="legend">
                        <strong>Keterangan:</strong> H = Hadir, S = Sakit, I = Izin, - = Alpha
                    </div>
                    
                    <div class="footer">
                        <div class="signature">
                            <div>Mengetahui,</div>
                            <div>Kepala Sekolah</div>
                            <div class="signature-line">
                                (..............................)
                            </div>
                        </div>
                        <div class="signature">
                            <div>Karawang, ${new Date().toLocaleDateString('id-ID')}</div>
                            <div>Guru Kelas</div>
                            <div class="signature-line">
                                ${teacherFilter}
                            </div>
                        </div>
                    </div>
                </body>
                </html>
            `;
            
            printWindow.document.write(printContent);
            printWindow.document.close();
            
            // Wait for content to load then print
            printWindow.onload = function() {
                printWindow.print();
                printWindow.onafterprint = function() {
                    printWindow.close();
                };
            };
        }

        // Load both teachers and students data when page loads
        window.addEventListener('load', async function() {
            checkLoginStatus(); // Check login status first
            loadSavedAttendanceData(); // Load saved attendance data first
            await loadTeachersData();
            await loadStudentsData();
            
            // Load attendance records
            const savedRecords = localStorage.getItem('allAttendanceRecords');
            if (savedRecords) {
                allAttendanceRecords = JSON.parse(savedRecords);
            }
            
            // Schedule automatic absent data checking
            scheduleAbsentDataCheck();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9644f19c156eb29b',t:'MTc1MzM3NjExMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
